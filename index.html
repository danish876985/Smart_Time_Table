<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f8f9fa">
    <title>SmartDay â€” Daily Planner</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <style>
        :root {
            --blue:#1a73e8; --blue-dk:#1557b0; --green:#1e8e3e;
            --red:#d93025; --yellow:#f9ab00;
            --surface:#ffffff; --bg:#f1f3f4; --border:#dadce0;
            --t1:#202124; --t2:#3c4043; --t3:#5f6368;
            --sh1:0 1px 2px rgba(60,64,67,.3),0 1px 3px rgba(60,64,67,.15);
            --sh2:0 1px 2px rgba(60,64,67,.3),0 2px 6px rgba(60,64,67,.15);
            --r:8px; --rl:16px;
            /* Detail panel */
            --panel-w:340px;
            --panel-transition:all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0;}
        body{font-family:'Roboto',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;padding:0 0 100px;-webkit-font-smoothing:antialiased;}

        /* â”€â”€ TOP BAR â”€â”€ */
        .topbar{background:var(--surface);border-bottom:1px solid var(--border);height:64px;padding:0 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;}
        .topbar-l{display:flex;align-items:center;gap:10px;}
        .logo{width:32px;height:32px;border-radius:8px;background:var(--blue);color:white;display:flex;align-items:center;justify-content:center;font-family:'Google Sans',sans-serif;font-weight:700;font-size:13px;}
        .appname{font-family:'Google Sans',sans-serif;font-size:18px;font-weight:500;color:var(--t1);}
        .topbar-r{display:flex;align-items:center;gap:8px;flex-wrap:nowrap;}
        .schip{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:50px;border:1px solid var(--border);font-size:12px;font-weight:500;color:var(--t3);background:#f8f9fa;transition:all .2s;}
        .schip.ok{border-color:#ceead6;background:#e6f4ea;color:var(--green);}
        .schip.busy{border-color:#c5d9f8;background:#e8f0fe;color:var(--blue);}
        .sdot{width:7px;height:7px;border-radius:50%;background:var(--t3);flex-shrink:0;transition:.2s;}
        .sdot.live{background:var(--green);}
        .sdot.spin{background:var(--blue);animation:pulse 1s infinite;}
        @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}
        /* TTL removed â€” token persists until 401 */
        .btn-drive{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);color:var(--t2);font-family:'Google Sans',sans-serif;font-size:13px;font-weight:500;padding:8px 16px;border-radius:4px;cursor:pointer;box-shadow:var(--sh1);transition:all .15s;white-space:nowrap;}
        .btn-drive:hover{background:#f8f9fa;box-shadow:var(--sh2);}
        .btn-help{display:flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;border:1px solid var(--border);background:var(--surface);color:var(--t3);cursor:pointer;box-shadow:var(--sh1);transition:all .15s;flex-shrink:0;}
        .btn-help:hover{background:#e8f0fe;color:var(--blue);border-color:var(--blue);}
        .btn-help .material-symbols-outlined{font-size:18px;}

        /* â”€â”€ MAIN LAYOUT (shrinks when detail panel is open) â”€â”€ */
        .app-body{display:flex;align-items:flex-start;gap:0;transition:var(--panel-transition);position:relative;}
        .main{max-width:960px;width:100%;margin:0 auto;padding:24px 24px 0;transition:var(--panel-transition);flex-shrink:1;}
        /* When detail panel open, shrink main */
        .app-body.panel-open .main{margin-right:0;max-width:calc(100% - var(--panel-w) - 16px);}

        .dbanner{display:none;align-items:center;gap:10px;background:#e8f0fe;border:1px solid #c5d9f8;border-radius:var(--r);padding:10px 16px;font-size:13px;color:var(--blue);margin-bottom:16px;}
        .dbanner.show{display:flex;}

        /* â”€â”€ PAGE HEADER â”€â”€ */
        .ph{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;gap:12px;}
        .ph-title{font-family:'Google Sans',sans-serif;font-size:26px;font-weight:400;color:var(--t1);}
        .ph-sub{font-size:13px;color:var(--t3);margin-top:2px;}

        /* â”€â”€ PROGRESS RING â”€â”€ */
        .pring{position:relative;width:56px;height:56px;flex-shrink:0;}
        .pring svg{transform:rotate(-90deg);}
        .pt{fill:none;stroke:var(--border);stroke-width:4;}
        .pf{fill:none;stroke:var(--blue);stroke-width:4;stroke-linecap:round;stroke-dasharray:141;stroke-dashoffset:141;transition:stroke-dashoffset .5s cubic-bezier(.4,0,.2,1);}
        .plbl{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Google Sans',sans-serif;font-size:11px;font-weight:500;color:var(--blue);}

        /* â”€â”€ STATS â”€â”€ */
        .stats{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;}
        .scard{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:12px 18px;display:flex;align-items:center;gap:10px;box-shadow:var(--sh1);flex:1;min-width:90px;}
        .sico{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;}
        .sico.b{background:#e8f0fe;color:var(--blue);}
        .sico.g{background:#e6f4ea;color:var(--green);}
        .sico.y{background:#fef7e0;color:var(--yellow);}
        .sico .material-symbols-outlined{font-size:17px;}
        .sval{font-family:'Google Sans',sans-serif;font-size:20px;font-weight:500;line-height:1;}
        .slbl{font-size:11px;color:var(--t3);margin-top:2px;}

        /* â”€â”€ CARD â”€â”€ */
        .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--rl);box-shadow:var(--sh1);overflow:hidden;}
        .card-hd{padding:14px 20px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
        .card-hd-t{font-family:'Google Sans',sans-serif;font-size:14px;font-weight:500;color:var(--t2);}
        .btn-add{background:none;border:none;color:var(--blue);font-family:'Google Sans',sans-serif;font-size:13px;font-weight:500;padding:6px 12px;border-radius:4px;cursor:pointer;transition:background .15s;}
        .btn-add:hover{background:rgba(26,115,232,.08);}

        /* â”€â”€ TABLE â”€â”€ */
        .twrap{overflow-x:auto;}
        table{width:100%;border-collapse:collapse;min-width:500px;}
        thead tr{border-bottom:1px solid var(--border);}
        th{padding:0 14px 12px;font-size:11px;font-weight:500;color:var(--t3);text-transform:uppercase;letter-spacing:.07em;text-align:left;white-space:nowrap;}
        tbody tr{border-bottom:1px solid var(--border);transition:background .1s;cursor:pointer;}
        tbody tr:last-child{border-bottom:none;}
        tbody tr:hover{background:#f0f6ff;}
        tbody tr.done td{opacity:.45;}
        tbody tr.done .tf{text-decoration:line-through;}
        /* Active row (detail panel open for this task) */
        tbody tr.active-row{background:#e8f0fe!important;outline:2px solid var(--blue);outline-offset:-2px;}
        tbody tr.active-row td{opacity:1!important;}
        td{padding:5px 14px;vertical-align:middle;}
        .rnum{font-size:11px;color:var(--t3);text-align:center;width:30px;}
        .gc{appearance:none;-webkit-appearance:none;width:18px;height:18px;border:2px solid var(--t3);border-radius:3px;cursor:pointer;display:grid;place-items:center;transition:all .15s;background:transparent;}
        .gc:checked{background:var(--blue);border-color:var(--blue);}
        .gc:checked::after{content:'';display:block;width:5px;height:9px;border:2px solid white;border-top:none;border-left:none;transform:rotate(45deg) translate(-1px,-1px);}
        .gc:hover{border-color:var(--blue);}
        .tf{border:none;background:transparent;font-family:'Roboto',sans-serif;font-size:13px;color:var(--t1);width:100%;padding:8px 6px;border-radius:4px;outline:none;transition:background .15s;}
        .tf:focus{background:#e8f0fe;}
        .ftm{width:85px;} .fdu{width:52px;text-align:center;}
        input[type=time].tf::-webkit-calendar-picker-indicator{opacity:.5;}
        .pp{display:inline-flex;align-items:center;padding:2px 9px;border-radius:50px;font-size:10px;font-weight:500;cursor:pointer;transition:filter .15s;user-select:none;white-space:nowrap;}
        .pp:hover{filter:brightness(.92);}
        .pph{background:#fce8e6;color:var(--red);}
        .ppm{background:#fef7e0;color:#b06000;}
        .ppl{background:#e6f4ea;color:var(--green);}
        .rdel{background:none;border:none;cursor:pointer;color:#ccc;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
        .rdel:hover{background:#fce8e6;color:var(--red);}
        .rdel .material-symbols-outlined{font-size:18px;}
        .empty{padding:60px 20px;text-align:center;color:var(--t3);}
        .empty .material-symbols-outlined{font-size:48px;opacity:.3;display:block;margin-bottom:10px;}
        .empty p{font-size:14px;}

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FEATURE 4 â€” TASK DETAIL PANEL (slide-in)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .detail-panel{
            position:fixed;
            top:64px;
            right:0;
            width:var(--panel-w);
            height:calc(100vh - 64px - 90px);
            background:var(--surface);
            border-left:1px solid var(--border);
            box-shadow:-4px 0 24px rgba(60,64,67,.12);
            display:flex;
            flex-direction:column;
            z-index:150;
            transform:translateX(100%);
            transition:var(--panel-transition);
            overflow:hidden;
        }
        .detail-panel.open{transform:translateX(0);}
        .dp-header{padding:16px 18px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0;}
        .dp-title{font-family:'Google Sans',sans-serif;font-size:14px;font-weight:500;color:var(--t1);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .dp-close{background:none;border:none;cursor:pointer;color:var(--t3);width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
        .dp-close:hover{background:#f1f3f4;color:var(--t1);}
        .dp-close .material-symbols-outlined{font-size:18px;}
        .dp-body{padding:18px;flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:16px;}
        .dp-meta{display:flex;gap:8px;flex-wrap:wrap;}
        .dp-chip{display:inline-flex;align-items:center;gap:4px;background:#f8f9fa;border:1px solid var(--border);border-radius:50px;padding:4px 10px;font-size:11px;color:var(--t2);}
        .dp-chip .material-symbols-outlined{font-size:13px;color:var(--t3);}
        .dp-field label{display:block;font-size:11px;font-weight:500;color:var(--t3);letter-spacing:.04em;text-transform:uppercase;margin-bottom:6px;}
        .dp-textarea{width:100%;border:1.5px solid var(--border);border-radius:var(--r);padding:10px 12px;font-family:'Roboto',sans-serif;font-size:13px;color:var(--t1);background:var(--surface);outline:none;resize:none;height:180px;line-height:1.6;transition:border-color .15s,box-shadow .15s;}
        .dp-textarea:focus{border-color:var(--blue);box-shadow:0 0 0 2px rgba(26,115,232,.12);}
        .dp-textarea::placeholder{color:#bdc1c6;}
        .dp-save-row{display:flex;justify-content:flex-end;}
        .dp-save-btn{display:flex;align-items:center;gap:6px;background:var(--blue);color:white;border:none;font-family:'Google Sans',sans-serif;font-size:13px;font-weight:500;padding:8px 18px;border-radius:4px;cursor:pointer;transition:background .15s;}
        .dp-save-btn:hover{background:var(--blue-dk);}
        .dp-save-btn .material-symbols-outlined{font-size:15px;}
        .dp-hint{font-size:11px;color:var(--t3);line-height:1.5;background:#f8f9fa;border-radius:var(--r);padding:10px 12px;}

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FEATURE 3 â€” WIN11-STYLE FLOATING DOCK
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .dock{
            position:fixed;
            bottom:18px;
            left:50%;
            transform:translateX(-50%);
            z-index:500;
            display:flex;
            align-items:center;
            gap:4px;
            background:rgba(255,255,255,0.72);
            backdrop-filter:blur(20px) saturate(180%);
            -webkit-backdrop-filter:blur(20px) saturate(180%);
            border:1px solid rgba(255,255,255,0.9);
            border-radius:18px;
            padding:8px 12px;
            box-shadow:0 8px 32px rgba(60,64,67,.18), 0 2px 8px rgba(60,64,67,.10), inset 0 1px 0 rgba(255,255,255,.8);
        }
        .dock-item{
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:3px;
            background:none;
            border:none;
            cursor:pointer;
            padding:6px 10px;
            border-radius:12px;
            color:var(--t2);
            font-family:'Roboto',sans-serif;
            font-size:9px;
            font-weight:500;
            letter-spacing:.02em;
            transition:all .18s cubic-bezier(.4,0,.2,1);
            min-width:52px;
            position:relative;
        }
        .dock-item:hover{background:rgba(26,115,232,.10);color:var(--blue);transform:translateY(-3px);}
        .dock-item:active{transform:translateY(-1px);}
        .dock-item .material-symbols-outlined{font-size:22px;transition:transform .18s;}
        .dock-item:hover .material-symbols-outlined{transform:scale(1.15);}
        .dock-item.active{color:var(--blue);}
        .dock-item.active::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--blue);}
        .dock-sep{width:1px;height:36px;background:var(--border);margin:0 4px;}
        /* FAB kept for AI button, now in dock */
        .dock-ai{background:var(--blue);color:white;border-radius:14px;padding:8px 16px;gap:6px;flex-direction:row;font-size:12px;}
        .dock-ai:hover{background:var(--blue-dk);color:white;transform:translateY(-3px);}

        /* â”€â”€ TOAST â”€â”€ */
        #toasts{position:fixed;top:68px;right:14px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
        .toast{background:var(--t1);color:white;padding:12px 16px;border-radius:var(--r);font-size:13px;box-shadow:0 3px 6px rgba(0,0,0,.25);animation:tin .25s ease,tout .3s ease 2.7s forwards;max-width:300px;pointer-events:auto;display:flex;align-items:center;gap:8px;}
        .toast::before{font-size:14px;flex-shrink:0;}
        .toast.ok::before{content:'âœ“';color:#81c995;}
        .toast.err::before{content:'âœ•';color:#f28b82;}
        .toast.inf::before{content:'â„¹';color:#8ab4f8;}
        @keyframes tin{from{transform:translateX(20px);opacity:0;}to{transform:translateX(0);opacity:1;}}
        @keyframes tout{to{opacity:0;transform:translateX(8px);}}

        /* â”€â”€ MODALS â€” shared overlay â”€â”€ */
        .mover{position:fixed;inset:0;background:rgba(32,33,36,.5);z-index:2000;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;}
        .mover.open{opacity:1;pointer-events:auto;}
        .msheet{background:var(--surface);border-radius:28px 28px 0 0;width:100%;max-width:640px;max-height:90vh;overflow-y:auto;transform:translateY(30px);transition:transform .3s cubic-bezier(.4,0,.2,1);}
        .mover.open .msheet{transform:translateY(0);}
        .mdrag{width:32px;height:4px;background:var(--border);border-radius:2px;margin:12px auto 0;}
        .mbody{padding:16px 24px 32px;}
        .mtitle{font-family:'Google Sans',sans-serif;font-size:18px;font-weight:500;color:var(--t1);margin-bottom:4px;}
        .msub{font-size:13px;color:var(--t3);margin-bottom:14px;}
        .pgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px;}
        .pcard{border:1.5px solid var(--border);border-radius:var(--r);padding:10px 12px;cursor:pointer;transition:all .15s;background:var(--surface);}
        .pcard:hover{border-color:var(--blue);background:#f0f6ff;}
        .pcard.sel{border-color:var(--blue);background:#e8f0fe;}
        .pname{font-family:'Google Sans',sans-serif;font-size:13px;font-weight:500;color:var(--t1);display:flex;align-items:center;gap:6px;}
        .pcard.sel .pname{color:var(--blue);}
        .psub{font-size:11px;color:var(--t3);margin-top:2px;}
        .ftag{background:#e6f4ea;color:var(--green);font-size:9px;font-weight:700;padding:1px 5px;border-radius:3px;text-transform:uppercase;letter-spacing:.04em;}
        .amsg{display:none;padding:9px 13px;border-radius:var(--r);font-size:12px;line-height:1.5;margin-bottom:10px;}
        .amsg.err{background:#fce8e6;border:1px solid #f5c6c2;color:#c5221f;}
        .amsg.wrn{background:#fef7e0;border:1px solid #fdd663;color:#7a4a00;}
        .gf{margin-bottom:12px;}
        .gf label{display:block;font-size:11px;font-weight:500;color:var(--t3);margin-bottom:4px;letter-spacing:.03em;}
        .gi,.gta{width:100%;border:1.5px solid var(--border);border-radius:var(--r);padding:10px 14px;font-family:'Roboto',sans-serif;font-size:14px;color:var(--t1);background:var(--surface);outline:none;transition:border-color .15s,box-shadow .15s;}
        .gi:focus,.gta:focus{border-color:var(--blue);box-shadow:0 0 0 2px rgba(26,115,232,.15);}
        .gta{resize:none;height:78px;}
        .khint{font-size:11px;color:var(--t3);margin-top:4px;}
        .khint a,.khint a:visited{color:var(--blue);text-decoration:none;}
        .khint a:hover{text-decoration:underline;}
        .chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
        .chip{background:#f8f9fa;border:1px solid var(--border);border-radius:50px;padding:5px 12px;font-size:12px;cursor:pointer;transition:all .15s;color:var(--t2);}
        .chip:hover{background:#e8f0fe;border-color:var(--blue);color:var(--blue);}
        .mact{display:flex;justify-content:flex-end;gap:8px;margin-top:14px;}
        .btxt{background:none;border:none;color:var(--blue);font-family:'Google Sans',sans-serif;font-size:14px;font-weight:500;padding:10px 16px;border-radius:4px;cursor:pointer;transition:background .15s;}
        .btxt:hover{background:rgba(26,115,232,.08);}
        .bcont{background:var(--blue);color:white;border:none;font-family:'Google Sans',sans-serif;font-size:14px;font-weight:500;padding:10px 22px;border-radius:4px;cursor:pointer;box-shadow:var(--sh1);transition:all .15s;display:flex;align-items:center;gap:6px;}
        .bcont:hover{background:var(--blue-dk);box-shadow:var(--sh2);}
        .bcont:disabled{opacity:.45;cursor:not-allowed;box-shadow:none;}

        /* â”€â”€ WELCOME MODAL â”€â”€ */
        .welcome-icon{font-size:48px;text-align:center;display:block;margin:8px 0 16px;}
        .welcome-steps{display:flex;flex-direction:column;gap:10px;margin:14px 0;}
        .ws{display:flex;align-items:flex-start;gap:12px;background:#f8f9fa;border-radius:var(--r);padding:12px 14px;}
        .ws-num{width:24px;height:24px;border-radius:50%;background:var(--blue);color:white;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;}
        .ws-t{font-family:'Google Sans',sans-serif;font-size:13px;font-weight:500;color:var(--t1);margin-bottom:2px;}
        .ws-d{font-size:12px;color:var(--t3);line-height:1.5;}
        .ws-badge{display:inline-flex;align-items:center;gap:4px;background:#e8f0fe;color:var(--blue);font-size:10px;font-weight:600;padding:2px 8px;border-radius:50px;margin-top:4px;}

        /* â”€â”€ INFO MODAL â”€â”€ */
        .info-sheet{background:var(--surface);border-radius:28px 28px 0 0;width:100%;max-width:680px;max-height:92vh;overflow-y:auto;transform:translateY(30px);transition:transform .3s cubic-bezier(.4,0,.2,1);}
        .mover.open .info-sheet{transform:translateY(0);}
        .info-hero{background:linear-gradient(135deg,var(--blue) 0%,#0d47a1 100%);border-radius:20px 20px 0 0;padding:28px 28px 22px;color:white;}
        .info-hero-title{font-family:'Google Sans',sans-serif;font-size:22px;font-weight:500;margin-bottom:4px;}
        .info-hero-sub{font-size:13px;opacity:.85;}
        .info-body{padding:20px 24px 36px;}
        .info-section{margin-bottom:22px;}
        .info-sec-hd{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
        .info-sec-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
        .info-sec-icon.blue{background:#e8f0fe;color:var(--blue);}
        .info-sec-icon.green{background:#e6f4ea;color:var(--green);}
        .info-sec-icon.yellow{background:#fef7e0;color:#f57f17;}
        .info-sec-icon .material-symbols-outlined{font-size:17px;}
        .info-sec-title{font-family:'Google Sans',sans-serif;font-size:14px;font-weight:500;color:var(--t1);}
        .info-sec-body{font-size:13px;color:var(--t2);line-height:1.7;}
        .info-sec-body p{margin-bottom:8px;}
        .info-step{display:flex;gap:10px;margin-bottom:8px;align-items:flex-start;}
        .info-step-n{background:var(--blue);color:white;width:20px;height:20px;border-radius:50%;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;}
        .info-step-t{font-size:13px;color:var(--t2);line-height:1.6;}
        .info-step-t strong{color:var(--t1);}
        .info-step-t a{color:var(--blue);text-decoration:none;}
        .info-divider{height:1px;background:var(--border);margin:18px 0;}
        .info-security-box{background:#e6f4ea;border:1px solid #ceead6;border-radius:var(--r);padding:14px 16px;display:flex;gap:12px;align-items:flex-start;}
        .info-security-box .material-symbols-outlined{color:var(--green);font-size:20px;flex-shrink:0;margin-top:1px;}
        .info-security-body{font-size:12px;color:#1e4620;line-height:1.6;}
        .provider-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;}
        .prov-card{background:#f8f9fa;border:1px solid var(--border);border-radius:var(--r);padding:10px 12px;}
        .prov-card-name{font-family:'Google Sans',sans-serif;font-size:12px;font-weight:500;color:var(--t1);margin-bottom:2px;}
        .prov-card-detail{font-size:11px;color:var(--t3);}
        .prov-card-detail a{color:var(--blue);text-decoration:none;}
        .free-badge{background:#e6f4ea;color:var(--green);font-size:9px;font-weight:700;padding:1px 5px;border-radius:3px;text-transform:uppercase;letter-spacing:.04em;margin-left:4px;}

        /* â”€â”€ SETTINGS MODAL â”€â”€ */
        .settings-sheet{background:var(--surface);border-radius:28px 28px 0 0;width:100%;max-width:560px;max-height:88vh;overflow-y:auto;transform:translateY(30px);transition:transform .3s cubic-bezier(.4,0,.2,1);}
        .mover.open .settings-sheet{transform:translateY(0);}
        .settings-section{margin-bottom:20px;}
        .settings-label{font-size:11px;font-weight:500;color:var(--t3);letter-spacing:.06em;text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:6px;}
        .settings-label .material-symbols-outlined{font-size:14px;}
        .cid-wrap{position:relative;display:flex;align-items:center;}
        .cid-input{width:100%;border:1.5px solid var(--border);border-radius:var(--r);padding:11px 44px 11px 14px;font-family:'Roboto Mono',monospace;font-size:12px;color:var(--t1);background:var(--surface);outline:none;transition:border-color .15s,box-shadow .15s;}
        .cid-input:focus{border-color:var(--blue);box-shadow:0 0 0 2px rgba(26,115,232,.15);}
        .cid-input.valid{border-color:#ceead6;}
        .cid-input.invalid{border-color:#f5c6c2;}
        .cid-eye{position:absolute;right:12px;background:none;border:none;cursor:pointer;color:var(--t3);display:flex;align-items:center;padding:0;}
        .cid-eye:hover{color:var(--blue);}
        .cid-eye .material-symbols-outlined{font-size:18px;}
        .cid-status{display:flex;align-items:center;gap:6px;font-size:12px;margin-top:6px;min-height:18px;}
        .cid-status.ok{color:var(--green);}
        .cid-status.err{color:var(--red);}
        .cid-status.hint{color:var(--t3);}
        .cid-status .material-symbols-outlined{font-size:14px;}
        .settings-hint-box{background:#f8f9fa;border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;font-size:12px;color:var(--t2);line-height:1.6;margin-top:10px;}
        .settings-hint-box strong{color:var(--t1);}
        .settings-hint-box a{color:var(--blue);text-decoration:none;}
        .settings-hint-box code{background:#e8f0fe;color:var(--blue);padding:1px 5px;border-radius:3px;font-size:11px;}
        .settings-divider{height:1px;background:var(--border);margin:18px 0;}
        .settings-danger-btn{display:flex;align-items:center;gap:8px;background:none;border:1px solid var(--border);color:var(--t3);font-family:'Google Sans',sans-serif;font-size:13px;padding:9px 16px;border-radius:var(--r);cursor:pointer;transition:all .15s;width:100%;}
        .settings-danger-btn:hover{border-color:var(--red);color:var(--red);background:#fce8e6;}
        .settings-danger-btn .material-symbols-outlined{font-size:16px;}

        @media(max-width:768px){
            .main{padding:14px 14px 0;}
            .topbar{padding:0 14px;}
            .appname{display:none;}
            .scard{min-width:80px;padding:10px 12px;}
            .sval{font-size:17px;}
            .provider-grid{grid-template-columns:1fr;}
            /* On mobile, detail panel goes full width */
            .detail-panel{width:100%;top:64px;height:calc(100vh - 64px - 80px);}
            .app-body.panel-open .main{display:none;}
            .dock{bottom:12px;padding:6px 8px;gap:2px;}
            .dock-item{min-width:44px;padding:5px 8px;}
            .dock-ai{padding:7px 12px;font-size:11px;}
        }
    </style>
</head>
<body>

<div id="toasts"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL 1 â€” AI PLANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="mover" id="aimodal" onclick="closeModal(event)">
  <div class="msheet">
    <div class="mdrag"></div>
    <div class="mbody">
      <div class="mtitle">AI Planner</div>
      <div class="msub">Pick a provider, paste your key, and describe how to update your day.</div>
      <div class="pgrid">
        <div class="pcard sel" onclick="selProv('groq')" id="prov-groq">
          <div class="pname">&#9889; Groq <span class="ftag">Free</span></div>
          <div class="psub">Llama 3.3 70B &middot; 14,400/day</div>
        </div>
        <div class="pcard" onclick="selProv('gemini')" id="prov-gemini">
          <div class="pname">&#11088; Gemini <span class="ftag">Free</span></div>
          <div class="psub">Gemini 2.0 Flash</div>
        </div>
        <div class="pcard" onclick="selProv('openrouter')" id="prov-openrouter">
          <div class="pname">&#128256; OpenRouter <span class="ftag">Free</span></div>
          <div class="psub">Llama 3.1 8B &middot; 30+ models</div>
        </div>
        <div class="pcard" onclick="selProv('openai')" id="prov-openai">
          <div class="pname">&#129302; OpenAI</div>
          <div class="psub">GPT-4o mini &middot; Paid</div>
        </div>
      </div>
      <div class="amsg" id="amsg"></div>
      <div class="gf">
        <label id="klbl">API KEY &mdash; GROQ</label>
        <input type="password" class="gi" id="akey" placeholder="gsk_..." autocomplete="off">
        <div class="khint" id="khint">Free key at <a href="https://console.groq.com/keys" target="_blank">console.groq.com/keys</a> &mdash; no credit card needed.</div>
      </div>
      <div id="key-save-row" style="display:none;margin-bottom:12px;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--t3);">
          <input type="checkbox" id="saveKeyToDrive" checked style="accent-color:var(--blue);width:14px;height:14px;">
          Save this API key to Drive for cross-device access
        </label>
      </div>
      <div class="chips">
        <div class="chip" onclick="setP('Push everything back 1 hour')">Push back 1hr</div>
        <div class="chip" onclick="setP('Add a 30-minute lunch break')">Add lunch</div>
        <div class="chip" onclick="setP('Optimize for deep work in the morning')">Deep work AM</div>
        <div class="chip" onclick="setP('Add 15-minute buffers between tasks')">Add buffers</div>
        <div class="chip" onclick="setP('Compress schedule to finish by 5pm')">Finish by 5pm</div>
      </div>
      <div class="gf">
        <label>YOUR REQUEST</label>
        <textarea class="gta" id="aprompt" placeholder="e.g. Move everything after 2pm and add a gym session..."></textarea>
      </div>
      <div class="mact">
        <button class="btxt" onclick="closeModal()">Cancel</button>
        <button class="bcont" id="aiBtn" onclick="runAI()">
          <span class="material-symbols-outlined" style="font-size:15px;">auto_awesome</span>
          Generate Plan
        </button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL 2 â€” WELCOME (first-time launch)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="mover" id="welcomemodal">
  <div class="msheet">
    <div class="mdrag"></div>
    <div class="mbody">
      <span class="welcome-icon">ğŸ‘‹</span>
      <div class="mtitle" style="text-align:center;">Welcome to SmartDay!</div>
      <div class="msub" style="text-align:center;">Your personal AI-powered daily planner â€” it lives right in this HTML file.</div>
      <div class="welcome-steps">
        <div class="ws">
          <div class="ws-num">1</div>
          <div>
            <div class="ws-t">Save this file somewhere safe</div>
            <div class="ws-d">This app is a single HTML file. Bookmark it in your browser or move it to a folder you won't lose. On mobile, use <strong>"Add to Home Screen"</strong> for app-like access.</div>
            <span class="ws-badge"><span class="material-symbols-outlined" style="font-size:12px;">bookmark</span> Save / Bookmark this file</span>
          </div>
        </div>
        <div class="ws">
          <div class="ws-num">2</div>
          <div>
            <div class="ws-t">Connect Google Drive for sync</div>
            <div class="ws-d">Tap <strong>Connect Drive</strong> in the top bar. Next time you open the app, it reconnects silently â€” no popup. Your data stays private in your own Drive.</div>
            <span class="ws-badge"><span class="material-symbols-outlined" style="font-size:12px;">cloud_sync</span> Auto-reconnects on return</span>
          </div>
        </div>
        <div class="ws">
          <div class="ws-num">3</div>
          <div>
            <div class="ws-t">Use AI to plan your day</div>
            <div class="ws-d">Tap <strong>AI Planner</strong> in the dock. Get a free key from Groq or Gemini. Once saved to Drive, your key works everywhere automatically.</div>
            <span class="ws-badge"><span class="material-symbols-outlined" style="font-size:12px;">auto_awesome</span> AI-powered scheduling</span>
          </div>
        </div>
        <div class="ws">
          <div class="ws-num">4</div>
          <div>
            <div class="ws-t">Click any task for details</div>
            <div class="ws-d">Click on a task row to open the <strong>Task Details</strong> side panel where you can add notes and descriptions that sync to Drive.</div>
            <span class="ws-badge"><span class="material-symbols-outlined" style="font-size:12px;">side_navigation</span> Slide-in detail panel</span>
          </div>
        </div>
      </div>
      <div class="mact">
        <button class="bcont" onclick="closeWelcome()" style="width:100%;justify-content:center;">
          <span class="material-symbols-outlined" style="font-size:15px;">check_circle</span>
          Got it â€” Let's plan my day!
        </button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL 3 â€” INFO / HELP HUB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="mover" id="infomodal" onclick="closeInfo(event)">
  <div class="info-sheet">
    <div class="mdrag"></div>
    <div class="info-hero">
      <div class="info-hero-title">ğŸ“… SmartDay â€” Help &amp; Setup</div>
      <div class="info-hero-sub">Everything you need to know to get the most out of your planner.</div>
    </div>
    <div class="info-body">
      <div class="info-section">
        <div class="info-sec-hd">
          <div class="info-sec-icon blue"><span class="material-symbols-outlined">cloud_sync</span></div>
          <div class="info-sec-title">Setting Up Google Drive Sync</div>
        </div>
        <div class="info-sec-body">
          <div class="info-step"><div class="info-step-n">1</div><div class="info-step-t">Go to <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com</a> and create a project.</div></div>
          <div class="info-step"><div class="info-step-n">2</div><div class="info-step-t">Enable the <strong>Google Drive API</strong> under APIs &amp; Services.</div></div>
          <div class="info-step"><div class="info-step-n">3</div><div class="info-step-t">Create an <strong>OAuth 2.0 Client ID</strong> (Web application).</div></div>
          <div class="info-step"><div class="info-step-n">4</div><div class="info-step-t">Add <code>null</code> (for local files) or your URL to Authorized JavaScript origins.</div></div>
          <div class="info-step"><div class="info-step-n">5</div><div class="info-step-t">Open <strong>âš™ï¸ Settings</strong> and paste your Client ID there â€” no code editing needed.</div></div>
          <div class="info-step"><div class="info-step-n">6</div><div class="info-step-t">Click <strong>Connect Drive</strong>. Future visits auto-reconnect silently.</div></div>
        </div>
      </div>
      <div class="info-divider"></div>
      <div class="info-section">
        <div class="info-sec-hd">
          <div class="info-sec-icon yellow"><span class="material-symbols-outlined">vpn_key</span></div>
          <div class="info-sec-title">Getting an AI API Key</div>
        </div>
        <div class="info-sec-body">
          <p>All providers below have free tiers â€” no credit card required:</p>
          <div class="provider-grid">
            <div class="prov-card"><div class="prov-card-name">âš¡ Groq <span class="free-badge">Free</span></div><div class="prov-card-detail"><a href="https://console.groq.com/keys" target="_blank">console.groq.com/keys</a></div></div>
            <div class="prov-card"><div class="prov-card-name">â­ Gemini <span class="free-badge">Free</span></div><div class="prov-card-detail"><a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a></div></div>
            <div class="prov-card"><div class="prov-card-name">ğŸ”„ OpenRouter <span class="free-badge">Free</span></div><div class="prov-card-detail"><a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a></div></div>
            <div class="prov-card"><div class="prov-card-name">ğŸ¤– OpenAI</div><div class="prov-card-detail"><a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a></div></div>
          </div>
        </div>
      </div>
      <div class="info-divider"></div>
      <div class="info-section">
        <div class="info-sec-hd">
          <div class="info-sec-icon green"><span class="material-symbols-outlined">shield</span></div>
          <div class="info-sec-title">Security &amp; Privacy</div>
        </div>
        <div class="info-security-box">
          <span class="material-symbols-outlined">verified_user</span>
          <div class="info-security-body">
            <strong>Your API key lives only in two places:</strong> browser memory (cleared on tab close) and your own private Drive file (<code>smartday_sync.json</code>). No SmartDay server ever touches it.<br><br>
            <strong>Drive scope:</strong> SmartDay only requests <code>drive.file</code> â€” it can only see files it created.<br><br>
            <strong>Token lifecycle:</strong> The Drive token stays active for the lifetime of your browser tab. It only expires if the Google API returns a 401, at which point you're prompted to reconnect.
          </div>
        </div>
      </div>
      <div class="mact">
        <button class="bcont" onclick="closeInfo()" style="justify-content:center;">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL 4 â€” SETTINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="mover" id="settingsmodal" onclick="closeSettings(event)">
  <div class="settings-sheet">
    <div class="mdrag"></div>
    <div class="mbody">
      <div class="mtitle">âš™ï¸ Settings</div>
      <div class="msub">Configure your Google Drive connection and app preferences.</div>
      <div class="settings-section">
        <div class="settings-label"><span class="material-symbols-outlined">key</span>Google OAuth Client ID</div>
        <div class="cid-wrap">
          <input class="cid-input" id="cid-input" type="password"
            placeholder="xxxxxxxxxxxx-xxxxxxxx.apps.googleusercontent.com"
            autocomplete="off" oninput="onCidInput()" onpaste="setTimeout(onCidInput,10)">
          <button class="cid-eye" id="cid-eye" onclick="toggleCidVisibility()" title="Show/Hide">
            <span class="material-symbols-outlined" id="cid-eye-icon">visibility</span>
          </button>
        </div>
        <div class="cid-status hint" id="cid-status">
          <span class="material-symbols-outlined">info</span>
          <span id="cid-status-txt">Paste your Client ID above to enable Google Drive sync.</span>
        </div>
        <div class="mact" style="margin-top:10px;">
          <button class="btxt" onclick="clearClientId()">Clear</button>
          <button class="bcont" id="cid-save-btn" onclick="saveClientId()" disabled>
            <span class="material-symbols-outlined" style="font-size:15px;">save</span>Save &amp; Apply
          </button>
        </div>
        <div class="settings-hint-box">
          <strong>How to get your Client ID:</strong><br>
          1. <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com</a> â†’ new project<br>
          2. APIs &amp; Services â†’ Enable <em>Google Drive API</em><br>
          3. Credentials â†’ OAuth 2.0 Client ID â†’ Web application<br>
          4. Authorized JS origins: <code>null</code> (local) or your site URL<br>
          5. Paste the ID above and hit <strong>Save &amp; Apply</strong>
        </div>
      </div>
      <div class="settings-divider"></div>
      <div class="settings-section">
        <div class="settings-label"><span class="material-symbols-outlined">restart_alt</span>Reset</div>
        <button class="settings-danger-btn" onclick="resetFirstLaunch()">
          <span class="material-symbols-outlined">replay</span>Show welcome screen again on next open
        </button>
        <button class="settings-danger-btn" style="margin-top:8px;" onclick="clearAllData()">
          <span class="material-symbols-outlined">delete_forever</span>Clear all local data &amp; tasks
        </button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TOP BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="topbar">
  <div class="topbar-l">
    <div class="logo">SD</div>
    <span class="appname">SmartDay</span>
  </div>
  <div class="topbar-r">
    <div class="schip" id="schip">
      <div class="sdot" id="sdot"></div>
      <span id="stxt">Local only</span>
    </div>
    <button class="btn-help" onclick="openInfo()" title="Help &amp; Setup">
      <span class="material-symbols-outlined">help_outline</span>
    </button>
    <button class="btn-help" onclick="openSettings()" title="Settings" id="settingsbtn">
      <span class="material-symbols-outlined">settings</span>
    </button>
    <button class="btn-drive" id="drivebtn" onclick="requestToken()">
      <svg width="16" height="16" viewBox="0 0 87.3 78" xmlns="http://www.w3.org/2000/svg">
        <path d="m6.6 66.85 3.85 6.65c.8 1.4 1.95 2.5 3.3 3.3l13.75-23.8H0c0 1.55.4 3.1 1.2 4.5z" fill="#0066da"/>
        <path d="M43.65 25 29.9 1.2C28.55 2 27.4 3.1 26.6 4.5L1.2 49.15C.4 50.55 0 52.1 0 53.65h27.5z" fill="#00ac47"/>
        <path d="M73.55 76.8c1.35-.8 2.5-1.9 3.3-3.3l1.6-2.75 7.65-13.25c.8-1.4 1.2-2.95 1.2-4.5H59.8l5.65 10.35z" fill="#ea4335"/>
        <path d="M43.65 25 57.4 1.2C56.05.4 54.5 0 52.95 0H34.35c-1.55 0-3.1.45-4.45 1.2z" fill="#00832d"/>
        <path d="M59.8 53.65H27.5L13.75 77.45c1.35.8 2.9 1.2 4.45 1.2h50.9c1.55 0 3.1-.45 4.45-1.2z" fill="#2684fc"/>
        <path d="M73.4 26.45l-12.7-22c-.8-1.4-1.95-2.5-3.3-3.3L43.65 25l16.15 28H87.3c0-1.55-.4-3.1-1.2-4.5z" fill="#ffba00"/>
      </svg>
      Connect Drive
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN CONTENT + DETAIL PANEL WRAPPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app-body" id="appBody">

  <!-- MAIN PANEL -->
  <div class="main" id="mainPanel">
    <div class="dbanner" id="dbanner">
      <span class="material-symbols-outlined" style="font-size:18px;">cloud_sync</span>
      <span id="dbanner-txt">Connected to Google Drive &mdash; auto-syncs every 3 s after changes</span>
    </div>
    <div class="ph">
      <div>
        <div class="ph-title" id="ptitle">Today's Plan</div>
        <div class="ph-sub" id="pdate"></div>
      </div>
      <div class="pring">
        <svg viewBox="0 0 56 56" width="56" height="56">
          <circle class="pt" cx="28" cy="28" r="22.5"/>
          <circle class="pf" id="parc" cx="28" cy="28" r="22.5"/>
        </svg>
        <div class="plbl" id="plbl">0%</div>
      </div>
    </div>
    <div class="stats">
      <div class="scard">
        <div class="sico b"><span class="material-symbols-outlined">checklist</span></div>
        <div><div class="sval" id="stotal">0</div><div class="slbl">Total</div></div>
      </div>
      <div class="scard">
        <div class="sico g"><span class="material-symbols-outlined">task_alt</span></div>
        <div><div class="sval" id="sdone">0</div><div class="slbl">Done</div></div>
      </div>
      <div class="scard">
        <div class="sico y"><span class="material-symbols-outlined">schedule</span></div>
        <div><div class="sval" id="stime">0h</div><div class="slbl">Scheduled</div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-hd">
        <div class="card-hd-t">Tasks <span style="font-size:11px;color:var(--t3);font-weight:400;margin-left:6px;">â€” click a row to add notes</span></div>
        <button class="btn-add" onclick="addRow()">+ Add task</button>
      </div>
      <div class="twrap" id="printarea">
        <table>
          <thead><tr>
            <th style="padding-left:20px;width:30px;">#</th>
            <th style="width:34px;"></th>
            <th style="width:88px;">Time</th>
            <th>Task</th>
            <th style="width:64px;">Mins</th>
            <th style="width:70px;">Priority</th>
            <th style="width:38px;"></th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="empty" class="empty" style="display:none;">
          <span class="material-symbols-outlined">event_note</span>
          <p>No tasks yet.<br>Tap <strong>+ Add task</strong> or use AI to build your plan.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- FEATURE 4 â€” TASK DETAIL PANEL -->
  <div class="detail-panel" id="detailPanel">
    <div class="dp-header">
      <span class="material-symbols-outlined" style="font-size:18px;color:var(--blue);flex-shrink:0;">sticky_note_2</span>
      <div class="dp-title" id="dp-title">Task Details</div>
      <button class="dp-close" onclick="closeDetailPanel()" title="Close panel">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="dp-body">
      <div class="dp-meta" id="dp-meta"></div>
      <div class="dp-field">
        <label>Notes &amp; Description</label>
        <textarea class="dp-textarea" id="dp-desc"
          placeholder="Add context, links, subtasks, or any notes for this task..."
          oninput="onDescInput()"></textarea>
      </div>
      <div class="dp-save-row">
        <button class="dp-save-btn" onclick="saveDesc()" id="dp-save-btn">
          <span class="material-symbols-outlined">save</span>Save Notes
        </button>
      </div>
      <div class="dp-hint">
        <span class="material-symbols-outlined" style="font-size:14px;vertical-align:middle;margin-right:4px;">info</span>
        Notes are saved locally and synced to Google Drive with your tasks.
      </div>
    </div>
  </div>

</div><!-- /app-body -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FEATURE 3 â€” FLOATING WIN11-STYLE DOCK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="dock" id="dock">
  <button class="dock-item" onclick="addRow()" title="New Task">
    <span class="material-symbols-outlined">add_circle</span>
    <span>New</span>
  </button>
  <button class="dock-item" onclick="openModal()" title="AI Planner" id="dock-ai-btn">
    <span class="material-symbols-outlined">auto_awesome</span>
    <span>AI</span>
  </button>
  <div class="dock-sep"></div>
  <button class="dock-item" onclick="exportPDF()" title="Export PDF">
    <span class="material-symbols-outlined">picture_as_pdf</span>
    <span>PDF</span>
  </button>
  <button class="dock-item" onclick="exportDOCX()" title="Export DOCX">
    <span class="material-symbols-outlined">description</span>
    <span>DOCX</span>
  </button>
  <div class="dock-sep"></div>
  <button class="dock-item" onclick="requestToken()" id="dock-drive-btn" title="Sync Drive">
    <span class="material-symbols-outlined">cloud_sync</span>
    <span>Sync</span>
  </button>
</div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let GOOGLE_CLIENT_ID = localStorage.getItem('sd_client_id') || 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tasks = JSON.parse(localStorage.getItem('smartday_v3')||'null') || [
    {id:uid(),text:'Morning Briefing',time:'09:00',duration:30,done:false,priority:'med',description:''},
    {id:uid(),text:'Deep Work Block', time:'10:00',duration:90,done:false,priority:'high',description:''}
];
const CIRC = 2*Math.PI*22.5;
let _storedApiKeys = {};
let activeTaskId = null; // currently open in detail panel

function uid(){return Math.random().toString(36).slice(2,9);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
    const tb=document.getElementById('tbody'),em=document.getElementById('empty');
    tb.innerHTML='';
    const sorted=[...tasks].sort((a,b)=>a.time.localeCompare(b.time));
    const done=tasks.filter(t=>t.done).length;
    const mins=tasks.reduce((s,t)=>s+(parseInt(t.duration)||0),0);
    if(!sorted.length){em.style.display='block';}
    else{
        em.style.display='none';
        sorted.forEach((t,i)=>{
            const tr=document.createElement('tr');
            const isActive = (t.id === activeTaskId);
            tr.className=(t.done?'done':'')+(isActive?' active-row':'');
            tr.dataset.id=t.id;
            const pc={high:'pph',med:'ppm',low:'ppl'};
            const pl={high:'High',med:'Med',low:'Low'};
            // Has description indicator
            const noteIco = t.description ? '<span class="material-symbols-outlined" style="font-size:13px;color:var(--blue);vertical-align:middle;margin-left:4px;" title="Has notes">sticky_note_2</span>' : '';
            tr.innerHTML=
                '<td class="rnum" style="padding-left:20px">'+(i+1)+'</td>'+
                '<td><input type="checkbox" class="gc"'+(t.done?' checked':'')+' onchange="toggle(\''+t.id+'\')" onclick="event.stopPropagation()"></td>'+
                '<td><input type="time" class="tf ftm" value="'+t.time+'" onblur="upd(\''+t.id+'\',\'time\',this.value)" onclick="event.stopPropagation()"></td>'+
                '<td><input type="text" class="tf" value="'+esc(t.text)+'" onblur="upd(\''+t.id+'\',\'text\',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()" onclick="event.stopPropagation()">'+noteIco+'</td>'+
                '<td><input type="number" class="tf fdu" value="'+t.duration+'" min="1" max="480" onblur="upd(\''+t.id+'\',\'duration\',parseInt(this.value)||30)" onclick="event.stopPropagation()"></td>'+
                '<td><span class="pp '+pc[t.priority]+'" onclick="event.stopPropagation();cyPrio(\''+t.id+'\')" title="Click to change">'+pl[t.priority]+'</span></td>'+
                '<td><button class="rdel" onclick="event.stopPropagation();del(\''+t.id+'\')" title="Delete"><span class="material-symbols-outlined">delete</span></button></td>';
            // Row click â†’ open detail panel
            tr.addEventListener('click', ()=>openDetailPanel(t.id));
            tb.appendChild(tr);
        });
    }
    const p=tasks.length?Math.round(done/tasks.length*100):0;
    const arc=document.getElementById('parc');
    arc.style.strokeDashoffset=CIRC-(CIRC*p/100);
    arc.style.stroke=p===100?'#1e8e3e':'#1a73e8';
    document.getElementById('plbl').textContent=p+'%';
    document.getElementById('stotal').textContent=tasks.length;
    document.getElementById('sdone').textContent=done;
    const h=mins/60;
    document.getElementById('stime').textContent=h>=1?h.toFixed(1)+'h':mins+'m';
    saveLocal();
    debSync();
}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TASK OPERATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggle(id){const t=tasks.find(t=>t.id===id);if(t){t.done=!t.done;render();}}
function upd(id,k,v){const t=tasks.find(t=>t.id===id);if(t){t[k]=v;render();}}
function del(id){
    if(activeTaskId===id) closeDetailPanel();
    tasks=tasks.filter(t=>t.id!==id);
    render();
    toast('Task removed','inf');
}
function addRow(){
    const newTask={id:uid(),text:'New task',time:'12:00',duration:30,done:false,priority:'med',description:''};
    tasks.push(newTask);
    render();
    setTimeout(()=>{
        const ins=document.querySelectorAll('.tf:not(.ftm):not(.fdu)');
        const l=ins[ins.length-1];
        if(l){l.focus();l.select();}
    },60);
}
function cyPrio(id){const t=tasks.find(t=>t.id===id);if(!t)return;t.priority={high:'med',med:'low',low:'high'}[t.priority]||'med';render();}
function saveLocal(){localStorage.setItem('smartday_v3',JSON.stringify(tasks));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 4 â€” TASK DETAIL PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDetailPanel(id){
    const t = tasks.find(t=>t.id===id);
    if(!t) return;

    activeTaskId = id;
    // Update panel content
    document.getElementById('dp-title').textContent = t.text || 'Task Details';
    document.getElementById('dp-desc').value = t.description || '';
    document.getElementById('dp-save-btn').textContent = '';
    document.getElementById('dp-save-btn').innerHTML = '<span class="material-symbols-outlined">save</span>Save Notes';

    // Meta chips
    const pc={high:'pph',med:'ppm',low:'ppl'};
    const pl={high:'High',med:'Med',low:'Low'};
    document.getElementById('dp-meta').innerHTML =
        '<span class="dp-chip"><span class="material-symbols-outlined">schedule</span>'+t.time+'</span>'+
        '<span class="dp-chip"><span class="material-symbols-outlined">timer</span>'+t.duration+'m</span>'+
        '<span class="dp-chip pp '+pc[t.priority]+'" style="border:none;">'+pl[t.priority]+'</span>'+
        (t.done ? '<span class="dp-chip" style="background:#e6f4ea;color:var(--green);border-color:#ceead6;"><span class="material-symbols-outlined">task_alt</span>Done</span>' : '');

    // Open panel & shrink main
    document.getElementById('detailPanel').classList.add('open');
    document.getElementById('appBody').classList.add('panel-open');
    // Re-render to highlight row
    render();
}

function closeDetailPanel(){
    activeTaskId = null;
    document.getElementById('detailPanel').classList.remove('open');
    document.getElementById('appBody').classList.remove('panel-open');
    render(); // clear active row highlight
}

function onDescInput(){
    // Could add auto-save here; for now manual save
}

function saveDesc(){
    if(!activeTaskId) return;
    const t = tasks.find(t=>t.id===activeTaskId);
    if(!t) return;
    t.description = document.getElementById('dp-desc').value;
    // Update panel title if task text changed
    document.getElementById('dp-title').textContent = t.text || 'Task Details';
    render();
    toast('Notes saved âœ“','ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 1 â€” PERSISTENT TOKEN (No TTL)
// Token lives in memory until the tab is closed or a 401 hits.
// Feature 5 â€” Silent auto-reconnect on page load.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let token=null, fileId=localStorage.getItem('sd_fid')||null;
const FNAME='smartday_sync.json';
const DAPI='https://www.googleapis.com/drive/v3';
const UAPI='https://www.googleapis.com/upload/drive/v3';
let _gisClient = null; // reuse same token client instance

function _buildGisClient(promptMode){
    // promptMode: '' for silent, undefined/omit for normal popup
    return google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope:'https://www.googleapis.com/auth/drive.file',
        prompt: promptMode,
        callback: async r => {
            if(r.error || !r.access_token){
                if(promptMode === ''){
                    // Silent auth failed â€” show button, do nothing else
                    showDriveBtn();
                    console.info('[SmartDay] Silent auth failed:', r.error||'no token');
                } else {
                    toast('Auth error: '+(r.error||'unknown'),'err');
                }
                return;
            }
            token = r.access_token;
            localStorage.setItem('sd_has_linked_drive','1');
            setSyncUI('ok','Drive connected');
            hideDriveBtn();
            document.getElementById('dbanner').classList.add('show');
            // Feature 1: No TTL, no countdown timer â€” token persists until 401
            toast('Connected to Google Drive','ok');
            await initDrive();
        }
    });
}

// Manual connect (shows account picker)
function requestToken(){
    if(typeof google==='undefined'){toast('Google SDK not loaded â€” check internet connection','err');return;}
    if(GOOGLE_CLIENT_ID.startsWith('YOUR_')){
        toast('Client ID not configured â€” tap âš™ï¸ Settings first','err');
        setTimeout(openSettings, 400);
        return;
    }
    _buildGisClient(undefined).requestAccessToken();
}

// Feature 5 â€” Silent auto-reconnect on DOMContentLoaded
function trySilentReconnect(){
    if(typeof google==='undefined'){return;}
    if(GOOGLE_CLIENT_ID.startsWith('YOUR_')){return;}
    const hasLinked = localStorage.getItem('sd_has_linked_drive');
    if(!hasLinked){return;}
    setSyncUI('busy','Reconnecting...');
    _buildGisClient('').requestAccessToken({prompt:''});
}

function showDriveBtn(){
    const db=document.getElementById('drivebtn');
    db.style.display='flex';
    // Keep original Drive SVG
    db.innerHTML=`<svg width="16" height="16" viewBox="0 0 87.3 78" xmlns="http://www.w3.org/2000/svg"><path d="m6.6 66.85 3.85 6.65c.8 1.4 1.95 2.5 3.3 3.3l13.75-23.8H0c0 1.55.4 3.1 1.2 4.5z" fill="#0066da"/><path d="M43.65 25 29.9 1.2C28.55 2 27.4 3.1 26.6 4.5L1.2 49.15C.4 50.55 0 52.1 0 53.65h27.5z" fill="#00ac47"/><path d="M73.55 76.8c1.35-.8 2.5-1.9 3.3-3.3l1.6-2.75 7.65-13.25c.8-1.4 1.2-2.95 1.2-4.5H59.8l5.65 10.35z" fill="#ea4335"/><path d="M43.65 25 57.4 1.2C56.05.4 54.5 0 52.95 0H34.35c-1.55 0-3.1.45-4.45 1.2z" fill="#00832d"/><path d="M59.8 53.65H27.5L13.75 77.45c1.35.8 2.9 1.2 4.45 1.2h50.9c1.55 0 3.1-.45 4.45-1.2z" fill="#2684fc"/><path d="M73.4 26.45l-12.7-22c-.8-1.4-1.95-2.5-3.3-3.3L43.65 25l16.15 28H87.3c0-1.55-.4-3.1-1.2-4.5z" fill="#ffba00"/></svg> Connect Drive`;
    setSyncUI('','Local only');
}
function hideDriveBtn(){
    document.getElementById('drivebtn').style.display='none';
}

// Called when a Drive request returns 401 â€” token silently expired server-side
function handleTokenExpired(){
    token=null;
    showDriveBtn();
    document.getElementById('dbanner').classList.remove('show');
    setSyncUI('','Reconnect Drive');
    toast('Drive session expired â€” tap Reconnect Drive','inf');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRIVE ENGINE
// Payload: { tasks: [...], apiKeys: {...} }
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildPayload(){
    return { tasks, apiKeys: _storedApiKeys };
}

async function initDrive(){
    if(!token)return;
    setSyncUI('busy','Checking Drive...');
    try{
        const q=encodeURIComponent("name='"+FNAME+"' and trashed=false");
        const r=await dReq(DAPI+'/files?q='+q+'&fields=files(id,name)','GET');
        const d=await r.json();
        if(d.files&&d.files.length>0){
            fileId=d.files[0].id;
            localStorage.setItem('sd_fid',fileId);
            await loadDrive();
            toast('Synced from Drive','ok');
        } else {
            await createDrive();
            toast('Drive file created','ok');
        }
        setSyncUI('ok','Drive synced');
    }catch(e){
        if(e.message.includes('401')){handleTokenExpired();return;}
        console.error('[Drive init]',e);
        setSyncUI('','Sync error');
        toast('Drive error: '+e.message,'err');
    }
}

async function createDrive(){
    const meta=await(await dReq(DAPI+'/files','POST',{name:FNAME,mimeType:'application/json'})).json();
    fileId=meta.id;
    localStorage.setItem('sd_fid',fileId);
    await uploadDrive();
}

// FEATURE 2 â€” Rock-solid API key persistence
async function loadDrive(){
    if(!token||!fileId)return;
    const r=await dReq(DAPI+'/files/'+fileId+'?alt=media','GET');
    const d=await r.json();

    // Support both old array format and new envelope format
    const rawTasks = Array.isArray(d) ? d : (Array.isArray(d.tasks) ? d.tasks : null);
    const rawKeys  = (!Array.isArray(d) && d.apiKeys && typeof d.apiKeys==='object') ? d.apiKeys : {};

    if(rawTasks){
        tasks = rawTasks.map(t=>({
            id:       t.id||uid(),
            text:     t.text||'Untitled',
            time:     /^\d{2}:\d{2}$/.test(t.time)?t.time:'09:00',
            duration: parseInt(t.duration)||30,
            done:     !!t.done,
            priority: ['high','med','low'].includes(t.priority)?t.priority:'med',
            description: t.description||''       // preserve notes
        }));
        saveLocal();
        render();
    }

    // FEATURE 2 â€” Silently restore API keys; populate AI modal field
    if(Object.keys(rawKeys).length > 0){
        _storedApiKeys = rawKeys;
        // Pre-fill whichever provider is currently selected
        const savedKey = _storedApiKeys[curProv];
        if(savedKey){
            document.getElementById('akey').value = savedKey;
        }
        document.getElementById('dbanner-txt').textContent =
            'Drive synced â€” tasks & API key ready on this device';
        // Subtle toast, not intrusive
        toast('Drive synced â€” API key loaded âœ“','ok');
    }
}

async function uploadDrive(){
    if(!token||!fileId)return;
    await dReq(UAPI+'/files/'+fileId+'?uploadType=media','PATCH',
        new Blob([JSON.stringify(buildPayload())],{type:'application/json'}),true);
    setSyncUI('ok','Drive synced');
}

// 4 â€” DEBOUNCED SYNC â€” 3 s
let _dt=null;
function debSync(){
    if(!token)return;
    setSyncUI('busy','Saving...');
    clearTimeout(_dt);
    _dt=setTimeout(async()=>{
        try{await uploadDrive();}
        catch(e){
            if(e.message.includes('401')){handleTokenExpired();return;}
            console.error('[sync]',e);setSyncUI('','Sync error');
        }
    },3000);
}

async function dReq(url,method,body,raw){
    if(!token)throw new Error('No token');
    const h={'Authorization':'Bearer '+token};
    if(body&&!raw)h['Content-Type']='application/json';
    const o={method:method||'GET',headers:h};
    if(body)o.body=raw?body:JSON.stringify(body);
    const r=await fetch(url,o);
    // Feature 1 â€” Only expire on actual 401
    if(r.status===401){token=null;throw new Error('401 Unauthorized');}
    if(r.status===429)throw new Error('Rate limit hit');
    return r;
}

function setSyncUI(state,txt){
    const c=document.getElementById('schip'),d=document.getElementById('sdot'),s=document.getElementById('stxt');
    s.textContent=txt; c.className='schip'; d.className='sdot';
    if(state==='ok'){c.classList.add('ok');d.classList.add('live');}
    else if(state==='busy'){c.classList.add('busy');d.classList.add('spin');}
    // Mirror sync state in dock
    const dockSync=document.getElementById('dock-drive-btn');
    if(dockSync){
        dockSync.classList.toggle('active', state==='ok');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI PROVIDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PROVS={
    groq:{name:'Groq',fmt:'oai',url:'https://api.groq.com/openai/v1/chat/completions',model:'llama-3.3-70b-versatile',
          hint:'Free key at <a href="https://console.groq.com/keys" target="_blank">console.groq.com/keys</a> â€” no credit card.',
          lbl:'API KEY â€” GROQ',ph:'gsk_...',pre:'gsk_'},
    gemini:{name:'Gemini',fmt:'gem',url:null,model:'gemini-2.0-flash',
            hint:'Free key at <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a> â€” no card.',
            lbl:'API KEY â€” GEMINI',ph:'AIza...',pre:'AIza'},
    openrouter:{name:'OpenRouter',fmt:'oai',url:'https://openrouter.ai/api/v1/chat/completions',model:'meta-llama/llama-3.1-8b-instruct:free',
                hint:'Free key at <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a> â€” no card.',
                lbl:'API KEY â€” OPENROUTER',ph:'sk-or-...',pre:'sk-or-'},
    openai:{name:'OpenAI',fmt:'oai',url:'https://api.openai.com/v1/chat/completions',model:'gpt-4o-mini',
            hint:'Key at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a> â€” paid.',
            lbl:'API KEY â€” OPENAI',ph:'sk-proj-...',pre:'sk-'}
};
let curProv='groq';

function selProv(id){
    curProv=id;
    document.querySelectorAll('.pcard').forEach(c=>c.classList.remove('sel'));
    document.getElementById('prov-'+id).classList.add('sel');
    const p=PROVS[id];
    document.getElementById('khint').innerHTML=p.hint;
    document.getElementById('klbl').textContent=p.lbl;
    document.getElementById('akey').placeholder=p.ph;
    document.getElementById('akey').value=_storedApiKeys[id]||'';
    clearMsg();
    if(id==='openai')showMsg('OpenAI may block calls from local files (CORS). Use Groq or OpenRouter â€” both are free.','wrn');
}

function openModal(){
    document.getElementById('aimodal').classList.add('open');
    clearMsg();
    document.getElementById('key-save-row').style.display = token ? 'block' : 'none';
    const stored=_storedApiKeys[curProv];
    if(stored) document.getElementById('akey').value=stored;
    setTimeout(()=>document.getElementById('aprompt').focus(),300);
}
function closeModal(e){if(!e||e.target===document.getElementById('aimodal'))document.getElementById('aimodal').classList.remove('open');}
function setP(t){document.getElementById('aprompt').value=t;document.getElementById('aprompt').focus();}
function showMsg(m,t){const el=document.getElementById('amsg');el.className='amsg '+(t||'err');el.innerHTML=m;el.style.display='block';}
function clearMsg(){document.getElementById('amsg').style.display='none';}

const PROXY='https://corsproxy.io/?url=';
async function sfetch(url,opts){
    try{return await fetch(url,opts);}
    catch(e){
        if(location.protocol!=='file:'&&location.hostname!=='localhost')throw new Error('Network error: '+e.message);
        return fetch(PROXY+encodeURIComponent(url),opts);
    }
}

function vKey(k,pid){
    const p=PROVS[pid];
    if(!k)return'No API key entered.';
    if(k.includes(' '))return'Key has spaces â€” re-copy carefully.';
    if(p.pre&&!k.startsWith(p.pre))return p.name+' keys start with "'+p.pre+'" â€” check provider.';
    if(k.length<20)return'Key looks too short.';
    return null;
}

async function callAI(p,key,sys,usr){
    if(p.fmt==='gem'){
        const url='https://generativelanguage.googleapis.com/v1beta/models/'+p.model+':generateContent?key='+key;
        let r;
        try{r=await sfetch(url,{method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:sys+'\n\n'+usr}]}],generationConfig:{temperature:.3,maxOutputTokens:1500}})});}
        catch(e){throw new Error('Cannot reach Gemini: '+e.message);}
        if(!r.ok){let m='HTTP '+r.status;try{const j=await r.json();m=j.error&&j.error.message||m;}catch(_){}
            if(r.status===401||r.status===403)throw new Error('Key rejected: '+m);
            if(r.status===429)throw new Error('Rate limit â€” wait.');
            throw new Error('Gemini '+r.status+': '+m);}
        const d=await r.json();
        return d.candidates?.[0]?.content?.parts?.[0]?.text||'';
    }
    const h={'Content-Type':'application/json','Authorization':'Bearer '+key};
    if(curProv==='openrouter'){h['HTTP-Referer']='https://smartday.app';h['X-Title']='SmartDay';}
    let r;
    try{r=await sfetch(p.url,{method:'POST',headers:h,body:JSON.stringify({model:p.model,max_tokens:1500,temperature:.3,
        messages:[{role:'system',content:sys},{role:'user',content:usr}]})});}
    catch(e){throw new Error('Cannot reach '+p.name+': '+e.message);}
    if(!r.ok){let m='HTTP '+r.status;try{const j=await r.json();m=j.error?.message||m;}catch(_){}
        if(r.status===401)throw new Error('Invalid key (401).');
        if(r.status===429)throw new Error('Rate limit (429).');
        throw new Error(p.name+' '+r.status+': '+m);}
    const d=await r.json();
    return d.choices?.[0]?.message?.content||'';
}

async function runAI(){
    const key=document.getElementById('akey').value.trim();
    const prompt=document.getElementById('aprompt').value.trim();
    const p=PROVS[curProv];
    clearMsg();
    const ke=vKey(key,curProv);
    if(ke){showMsg(ke);return;}
    if(!prompt){showMsg('Describe what you want to change.');return;}

    // FEATURE 2 â€” Save key to Drive if checkbox checked
    const saveKeyCb=document.getElementById('saveKeyToDrive');
    if(saveKeyCb&&saveKeyCb.checked&&token){
        _storedApiKeys[curProv]=key;
    }

    const btn=document.getElementById('aiBtn');
    btn.disabled=true;
    btn.innerHTML='<span style="font-size:13px;">â³</span> Processing...';
    setSyncUI('busy',p.name+'...');
    const SYS='You are a productivity planner. Return ONLY a raw JSON array (no markdown, no backticks). Each item: "id"(keep if existing,else short random),"text"(string),"time"(HH:MM 24h),"duration"(int minutes),"done"(bool),"priority"("high"|"med"|"low"),"description"(string,keep existing).';
    const USR='Tasks:\n'+JSON.stringify(tasks)+'\n\nRequest: '+prompt;
    try{
        let raw=await callAI(p,key,SYS,USR);
        raw=raw.trim().replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/```\s*$/,'').trim();
        if(raw.startsWith('{')){const o=JSON.parse(raw);const k=Object.keys(o).find(k=>Array.isArray(o[k]));if(k)raw=JSON.stringify(o[k]);}
        const arr=JSON.parse(raw);
        if(!Array.isArray(arr))throw new Error('Expected JSON array.');
        tasks=arr.map(t=>({
            id:t.id||uid(),text:String(t.text||'Untitled'),
            time:/^\d{2}:\d{2}$/.test(t.time)?t.time:'09:00',
            duration:parseInt(t.duration)||30,done:!!t.done,
            priority:['high','med','low'].includes(t.priority)?t.priority:'med',
            description:t.description||''
        }));
        render(); closeModal(); toast('Plan updated via '+p.name,'ok');
        if(saveKeyCb&&saveKeyCb.checked&&token) toast('API key saved to Drive âœ“','ok');
    }catch(e){
        console.error('[AI]',e);
        showMsg('<strong>'+p.name+' error:</strong> '+e.message);
        toast(p.name+' failed','err');
    }finally{
        btn.disabled=false;
        btn.innerHTML='<span class="material-symbols-outlined" style="font-size:15px;">auto_awesome</span> Generate Plan';
        setSyncUI(token?'ok':'',token?'Drive synced':'Local only');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPDF(){
    toast('Generating PDF...','inf');
    html2pdf().set({margin:.5,filename:'SmartDay_'+new Date().toISOString().slice(0,10)+'.pdf',
        html2canvas:{scale:2,backgroundColor:'#fff'},jsPDF:{unit:'in',format:'letter',orientation:'portrait'}})
    .from(document.getElementById('printarea')).save();
}
function exportDOCX(){
    const{Document,Packer,Paragraph,TextRun,HeadingLevel}=docx;
    const s=[...tasks].sort((a,b)=>a.time.localeCompare(b.time));
    const doc=new Document({sections:[{children:[
        new Paragraph({text:'SmartDay â€” '+new Date().toDateString(),heading:HeadingLevel.HEADING_1}),
        new Paragraph({text:''}),
        ...s.flatMap(t=>[
            new Paragraph({children:[
                new TextRun({text:t.time+'  ',bold:true}),
                new TextRun({text:t.text+(t.done?' (done)':''),strike:t.done}),
                new TextRun({text:'  ('+t.duration+'m)',color:'888888'})
            ]}),
            ...(t.description?[new Paragraph({children:[new TextRun({text:'  '+t.description,color:'666666',italics:true})]})]:[])
        ])
    ]}]});
    Packer.toBlob(doc).then(b=>{saveAs(b,'SmartDay_'+new Date().toISOString().slice(0,10)+'.docx');toast('DOCX saved','ok');});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg,type){
    const el=document.createElement('div');
    el.className='toast '+(type||'inf');
    el.textContent=msg;
    document.getElementById('toasts').appendChild(el);
    setTimeout(()=>el.remove(),3200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL CONTROLLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openInfo(){document.getElementById('infomodal').classList.add('open');}
function closeInfo(e){if(!e||e.target===document.getElementById('infomodal'))document.getElementById('infomodal').classList.remove('open');}
function openWelcome(){document.getElementById('welcomemodal').classList.add('open');}
function closeWelcome(){document.getElementById('welcomemodal').classList.remove('open');localStorage.setItem('sd_returning','1');}

function openSettings(){
    document.getElementById('settingsmodal').classList.add('open');
    const inp=document.getElementById('cid-input');
    inp.value=localStorage.getItem('sd_client_id')||'';
    updateCidStatus(inp.value);
}
function closeSettings(e){if(!e||e.target===document.getElementById('settingsmodal'))document.getElementById('settingsmodal').classList.remove('open');}

function toggleCidVisibility(){
    const inp=document.getElementById('cid-input'),icon=document.getElementById('cid-eye-icon');
    inp.type=inp.type==='password'?'text':'password';
    icon.textContent=inp.type==='password'?'visibility':'visibility_off';
}
function onCidInput(){
    const val=document.getElementById('cid-input').value.trim();
    updateCidStatus(val);
    document.getElementById('cid-save-btn').disabled=!isValidCid(val);
}
function isValidCid(v){return v.length>20&&v.includes('.apps.googleusercontent.com')&&!v.startsWith('YOUR_');}
function updateCidStatus(val){
    const el=document.getElementById('cid-status'),txt=document.getElementById('cid-status-txt'),inp=document.getElementById('cid-input');
    inp.classList.remove('valid','invalid');
    if(!val){el.className='cid-status hint';el.querySelector('.material-symbols-outlined').textContent='info';txt.textContent='Paste your Client ID to enable Drive sync.';return;}
    if(isValidCid(val)){el.className='cid-status ok';el.querySelector('.material-symbols-outlined').textContent='check_circle';txt.textContent=localStorage.getItem('sd_client_id')===val?'Client ID active â€” ready.':'Looks valid! Hit Save & Apply.';inp.classList.add('valid');}
    else{el.className='cid-status err';el.querySelector('.material-symbols-outlined').textContent='error';txt.textContent=val.startsWith('YOUR_')?'Still a placeholder â€” paste your real Client ID.':'Should end in .apps.googleusercontent.com';inp.classList.add('invalid');}
}
function saveClientId(){
    const val=document.getElementById('cid-input').value.trim();
    if(!isValidCid(val)){toast('Invalid Client ID','err');return;}
    localStorage.setItem('sd_client_id',val);
    GOOGLE_CLIENT_ID=val;
    updateCidStatus(val);
    document.getElementById('cid-save-btn').disabled=true;
    showDriveBtn();
    toast('Client ID saved â€” tap Connect Drive!','ok');
    updateSettingsBadge();
    setTimeout(()=>document.getElementById('settingsmodal').classList.remove('open'),1200);
}
function clearClientId(){document.getElementById('cid-input').value='';onCidInput();document.getElementById('cid-save-btn').disabled=true;}
function resetFirstLaunch(){localStorage.removeItem('sd_returning');toast('Welcome shows on next open','ok');document.getElementById('settingsmodal').classList.remove('open');}
function clearAllData(){
    if(!confirm('Delete all local tasks and settings?'))return;
    closeDetailPanel();
    localStorage.clear();
    tasks=[];
    render();
    toast('All data cleared','inf');
    document.getElementById('settingsmodal').classList.remove('open');
}
function updateSettingsBadge(){
    const btn=document.getElementById('settingsbtn'),stored=localStorage.getItem('sd_client_id');
    if(!stored||stored.startsWith('YOUR_')){btn.style.borderColor='#f9ab00';btn.style.color='#f57f17';btn.title='Settings â€” Client ID not configured';}
    else{btn.style.borderColor='';btn.style.color='';btn.title='Settings';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIRST-LAUNCH CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkFirstLaunch(){
    if(!localStorage.getItem('sd_returning')) setTimeout(openWelcome, 700);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded',()=>{
    const now=new Date();
    document.getElementById('pdate').textContent=now.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
    document.getElementById('ptitle').textContent=now.toLocaleDateString('en-US',{weekday:'long'})+"'s Plan";

    document.addEventListener('keydown',e=>{
        if(e.key==='Escape'){
            closeModal();
            closeInfo();
            closeSettings();
            closeDetailPanel();
            document.getElementById('welcomemodal').classList.remove('open');
        }
    });

    render();
    updateSettingsBadge();
    checkFirstLaunch();

    // Feature 5 â€” Attempt silent Drive reconnect after GIS SDK loads
    // GIS is async-deferred so we poll for readiness
    const _silentRetry = setInterval(()=>{
        if(typeof google!=='undefined'&&google.accounts&&google.accounts.oauth2){
            clearInterval(_silentRetry);
            trySilentReconnect();
        }
    }, 200);
    // Give up after 8 s if SDK never loads
    setTimeout(()=>clearInterval(_silentRetry), 8000);
});
</script>
</body>
</html>
