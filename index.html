<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f8f9fa">
    <title>SmartDay ‚Äî Daily Planner</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <style>
        :root {
            --blue:#1a73e8; --blue-dk:#1557b0; --green:#1e8e3e;
            --red:#d93025; --yellow:#f9ab00;
            --surface:#ffffff; --bg:#f1f3f4; --border:#dadce0;
            --t1:#202124; --t2:#3c4043; --t3:#5f6368;
            --sh1:0 1px 2px rgba(60,64,67,.3),0 1px 3px rgba(60,64,67,.15);
            --sh2:0 1px 2px rgba(60,64,67,.3),0 2px 6px rgba(60,64,67,.15);
            --r:8px; --rl:16px;
            /* Detail panel */
            --panel-w:340px;
            --panel-transition:all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0;}
        body{font-family:'Roboto',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;padding:0 0 100px;-webkit-font-smoothing:antialiased;}

        /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
        .topbar{background:var(--surface);border-bottom:1px solid var(--border);height:64px;padding:0 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;}
        .topbar-l{display:flex;align-items:center;gap:10px;}
        .logo{width:32px;height:32px;border-radius:8px;background:var(--blue);color:white;display:flex;align-items:center;justify-content:center;font-family:'Google Sans',sans-serif;font-weight:700;font-size:13px;}
        .appname{font-family:'Google Sans',sans-serif;font-size:18px;font-weight:500;color:var(--t1);}
        .topbar-r{display:flex;align-items:center;gap:8px;flex-wrap:nowrap;}
        .schip{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:50px;border:1px solid var(--border);font-size:12px;font-weight:500;color:var(--t3);background:#f8f9fa;transition:all .2s;}
        .schip.ok{border-color:#ceead6;background:#e6f4ea;color:var(--green);}
        .schip.busy{border-color:#c5d9f8;background:#e8f0fe;color:var(--blue);}
        .sdot{width:7px;height:7px;border-radius:50%;background:var(--t3);flex-shrink:0;transition:.2s;}
        .sdot.live{background:var(--green);}
        .sdot.spin{background:var(--blue);animation:pulse 1s infinite;}
        @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}
        /* TTL removed ‚Äî token persists until 401 */
        .btn-drive{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);color:var(--t2);font-family:'Google Sans',sans-serif;font-size:13px;font-weight:500;padding:8px 16px;border-radius:4px;cursor:pointer;box-shadow:var(--sh1);transition:all .15s;white-space:nowrap;}
        .btn-drive:hover{background:#f8f9fa;box-shadow:var(--sh2);}
        .btn-help{display:flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;border:1px solid var(--border);background:var(--surface);color:var(--t3);cursor:pointer;box-shadow:var(--sh1);transition:all .15s;flex-shrink:0;}
        .btn-help:hover{background:#e8f0fe;color:var(--blue);border-color:var(--blue);}
        .btn-help .material-symbols-outlined{font-size:18px;}

        /* ‚îÄ‚îÄ MAIN LAYOUT (shrinks when detail panel is open) ‚îÄ‚îÄ */
        .app-body{display:flex;align-items:flex-start;gap:0;transition:var(--panel-transition);position:relative;}
        .main{max-width:960px;width:100%;margin:0 auto;padding:24px 24px 0;transition:var(--panel-transition);flex-shrink:1;}
        /* When detail panel open, shrink main */
        .app-body.panel-open .main{margin-right:0;max-width:calc(100% - var(--panel-w) - 16px);}

        .dbanner{display:none;align-items:center;gap:10px;background:#e8f0fe;border:1px solid #c5d9f8;border-radius:var(--r);padding:10px 16px;font-size:13px;color:var(--blue);margin-bottom:16px;}
        .dbanner.show{display:flex;}

        /* ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ */
        .ph{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;gap:12px;}
        .ph-title{font-family:'Google Sans',sans-serif;font-size:26px;font-weight:400;color:var(--t1);}
        .ph-sub{font-size:13px;color:var(--t3);margin-top:2px;}

        /* ‚îÄ‚îÄ PROGRESS RING ‚îÄ‚îÄ */
        .pring{position:relative;width:56px;height:56px;flex-shrink:0;}
        .pring svg{transform:rotate(-90deg);}
        .pt{fill:none;stroke:var(--border);stroke-width:4;}
        .pf{fill:none;stroke:var(--blue);stroke-width:4;stroke-linecap:round;stroke-dasharray:141;stroke-dashoffset:141;transition:stroke-dashoffset .5s cubic-bezier(.4,0,.2,1);}
        .plbl{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Google Sans',sans-serif;font-size:11px;font-weight:500;color:var(--blue);}

        /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
        .stats{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;}
        .scard{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:12px 18px;display:flex;align-items:center;gap:10px;box-shadow:var(--sh1);flex:1;min-width:90px;}
        .sico{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;}
        .sico.b{background:#e8f0fe;color:var(--blue);}
        .sico.g{background:#e6f4ea;color:var(--green);}
        .sico.y{background:#fef7e0;color:var(--yellow);}
        .sico .material-symbols-outlined{font-size:17px;}
        .sval{font-family:'Google Sans',sans-serif;font-size:20px;font-weight:500;line-height:1;}
        .slbl{font-size:11px;color:var(--t3);margin-top:2px;}

        /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
        .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--rl);box-shadow:var(--sh1);overflow:hidden;}
        .card-hd{padding:14px 20px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
        .card-hd-t{font-family:'Google Sans',sans-serif;font-size:14px;font-weight:500;color:var(--t2);}
        .btn-add{background:none;border:none;color:var(--blue);font-family:'Google Sans',sans-serif;font-size:13px;font-weight:500;padding:6px 12px;border-radius:4px;cursor:pointer;transition:background .15s;}
        .btn-add:hover{background:rgba(26,115,232,.08);}

        /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
        .twrap{overflow-x:auto;}
        table{width:100%;border-collapse:collapse;min-width:500px;}
        thead tr{border-bottom:1px solid var(--border);}
        th{padding:0 14px 12px;font-size:11px;font-weight:500;color:var(--t3);text-transform:uppercase;letter-spacing:.07em;text-align:left;white-space:nowrap;}
        tbody tr{border-bottom:1px solid var(--border);transition:background .1s;cursor:pointer;}
        tbody tr:last-child{border-bottom:none;}
        tbody tr:hover{background:#f0f6ff;}
        tbody tr.done td{opacity:.45;}
        tbody tr.done .tf{text-decoration:line-through;}
        /* Active row (detail panel open for this task) */
        tbody tr.active-row{background:#e8f0fe!important;outline:2px solid var(--blue);outline-offset:-2px;}
        tbody tr.active-row td{opacity:1!important;}
        td{padding:5px 14px;vertical-align:middle;}
        .rnum{font-size:11px;color:var(--t3);text-align:center;width:30px;}
        .gc{appearance:none;-webkit-appearance:none;width:18px;height:18px;border:2px solid var(--t3);border-radius:3px;cursor:pointer;display:grid;place-items:center;transition:all .15s;background:transparent;}
        .gc:checked{background:var(--blue);border-color:var(--blue);}
        .gc:checked::after{content:'';display:block;width:5px;height:9px;border:2px solid white;border-top:none;border-left:none;transform:rotate(45deg) translate(-1px,-1px);}
        .gc:hover{border-color:var(--blue);}
        .tf{border:none;background:transparent;font-family:'Roboto',sans-serif;font-size:13px;color:var(--t1);width:100%;padding:8px 6px;border-radius:4px;outline:none;transition:background .15s;}
        .tf:focus{background:#e8f0fe;}
        .ftm{width:85px;} .fdu{width:52px;text-align:center;}
        input[type=time].tf::-webkit-calendar-picker-indicator{opacity:.5;}
        .pp{display:inline-flex;align-items:center;padding:2px 9px;border-radius:50px;font-size:10px;font-weight:500;cursor:pointer;transition:filter .15s;user-select:none;white-space:nowrap;}
        .pp:hover{filter:brightness(.92);}
        .pph{background:#fce8e6;color:var(--red);}
        .ppm{background:#fef7e0;color:#b06000;}
        .ppl{background:#e6f4ea;color:var(--green);}
        .rdel{background:none;border:none;cursor:pointer;color:#ccc;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
        .rdel:hover{background:#fce8e6;color:var(--red);}
        .rdel .material-symbols-outlined{font-size:18px;}
        .empty{padding:60px 20px;text-align:center;color:var(--t3);}
        .empty .material-symbols-outlined{font-size:48px;opacity:.3;display:block;margin-bottom:10px;}
        .empty p{font-size:14px;}

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           FEATURE 4 ‚Äî TASK DETAIL PANEL (slide-in)
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .detail-panel{
            position:fixed;
            top:64px;
            right:0;
            width:var(--panel-w);
            height:calc(100vh - 64px - 90px);
            background:var(--surface);
            border-left:1px solid var(--border);
            box-shadow:-4px 0 24px rgba(60,64,67,.12);
            display:flex;
            flex-direction:column;
            z-index:150;
            transform:translateX(100%);
            transition:var(--panel-transition);
            overflow:hidden;
        }
        .detail-panel.open{transform:translateX(0);}
        .dp-header{padding:16px 18px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0;}
        .dp-title{font-family:'Google Sans',sans-serif;font-size:14px;font-weight:500;color:var(--t1);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .dp-close{background:none;border:none;cursor:pointer;color:var(--t3);width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
        .dp-close:hover{background:#f1f3f4;color:var(--t1);}
        .dp-close .material-symbols-outlined{font-size:18px;}
        .dp-body{padding:18px;flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:16px;}
        .dp-meta{display:flex;gap:8px;flex-wrap:wrap;}
        .dp-chip{display:inline-flex;align-items:center;gap:4px;background:#f8f9fa;border:1px solid var(--border);border-radius:50px;padding:4px 10px;font-size:11px;color:var(--t2);}
        .dp-chip .material-symbols-outlined{font-size:13px;color:var(--t3);}
        .dp-field label{display:block;font-size:11px;font-weight:500;color:var(--t3);letter-spacing:.04em;text-transform:uppercase;margin-bottom:6px;}
        .dp-textarea{width:100%;border:1.5px solid var(--border);border-radius:var(--r);padding:10px 12px;font-family:'Roboto',sans-serif;font-size:13px;color:var(--t1);background:var(--surface);outline:none;resize:none;height:180px;line-height:1.6;transition:border-color .15s,box-shadow .15s;}
        .dp-textarea:focus{border-color:var(--blue);box-shadow:0 0 0 2px rgba(26,115,232,.12);}
        .dp-textarea::placeholder{color:#bdc1c6;}
        .dp-save-row{display:flex;justify-content:flex-end;}
        .dp-save-btn{display:flex;align-items:center;gap:6px;background:var(--blue);color:white;border:none;font-family:'Google Sans',sans-serif;font-size:13px;font-weight:500;padding:8px 18px;border-radius:4px;cursor:pointer;transition:background .15s;}
        .dp-save-btn:hover{background:var(--blue-dk);}
        .dp-save-btn .material-symbols-outlined{font-size:15px;}
        .dp-hint{font-size:11px;color:var(--t3);line-height:1.5;background:#f8f9fa;border-radius:var(--r);padding:10px 12px;}

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           FEATURE 3 ‚Äî WIN11-STYLE FLOATING DOCK
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .dock{
            position:fixed;
            bottom:18px;
            left:50%;
            transform:translateX(-50%);
            z-index:500;
            display:flex;
            align-items:center;
            gap:4px;
            background:rgba(255,255,255,0.72);
            backdrop-filter:blur(20px) saturate(180%);
            -webkit-backdrop-filter:blur(20px) saturate(180%);
            border:1px solid rgba(255,255,255,0.9);
            border-radius:18px;
            padding:8px 12px;
            box-shadow:0 8px 32px rgba(60,64,67,.18), 0 2px 8px rgba(60,64,67,.10), inset 0 1px 0 rgba(255,255,255,.8);
        }
        .dock-item{
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:3px;
            background:none;
            border:none;
            cursor:pointer;
            padding:6px 10px;
            border-radius:12px;
            color:var(--t2);
            font-family:'Roboto',sans-serif;
            font-size:9px;
            font-weight:500;
            letter-spacing:.02em;
            transition:all .18s cubic-bezier(.4,0,.2,1);
            min-width:52px;
            position:relative;
        }
        .dock-item:hover{background:rgba(26,115,232,.10);color:var(--blue);transform:translateY(-3px);}
        .dock-item:active{transform:translateY(-1px);}
        .dock-item .material-symbols-outlined{font-size:22px;transition:transform .18s;}
        .dock-item:hover .material-symbols-outlined{transform:scale(1.15);}
        .dock-item.active{color:var(--blue);}
        .dock-item.active::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--blue);}
        .dock-sep{width:1px;height:36px;background:var(--border);margin:0 4px;}
        /* FAB kept for AI button, now in dock */
        .dock-ai{background:var(--blue);color:white;border-radius:14px;padding:8px 16px;gap:6px;flex-direction:row;font-size:12px;}
        .dock-ai:hover{background:var(--blue-dk);color:white;transform:translateY(-3px);}

        /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
        #toasts{position:fixed;top:68px;right:14px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
        .toast{background:var(--t1);color:white;padding:12px 16px;border-radius:var(--r);font-size:13px;box-shadow:0 3px 6px rgba(0,0,0,.25);animation:tin .25s ease,tout .3s ease 2.7s forwards;max-width:300px;pointer-events:auto;display:flex;align-items:center;gap:8px;}
        .toast::before{font-size:14px;flex-shrink:0;}
        .toast.ok::before{content:'‚úì';color:#81c995;}
        .toast.err::before{content:'‚úï';color:#f28b82;}
        .toast.inf::before{content:'‚Ñπ';color:#8ab4f8;}
        @keyframes tin{from{transform:translateX(20px);opacity:0;}to{transform:translateX(0);opacity:1;}}
        @keyframes tout{to{opacity:0;transform:translateX(8px);}}

        /* ‚îÄ‚îÄ MODALS ‚Äî shared overlay ‚îÄ‚îÄ */
        .mover{position:fixed;inset:0;background:rgba(32,33,36,.5);z-index:2000;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;}
        .mover.open{opacity:1;pointer-events:auto;}
        .msheet{background:var(--surface);border-radius:28px 28px 0 0;width:100%;max-width:640px;max-height:90vh;overflow-y:auto;transform:translateY(30px);transition:transform .3s cubic-bezier(.4,0,.2,1);}
        .mover.open .msheet{transform:translateY(0);}
        .mdrag{width:32px;height:4px;background:var(--border);border-radius:2px;margin:12px auto 0;}
        .mbody{padding:16px 24px 32px;}
        .mtitle{font-family:'Google Sans',sans-serif;font-size:18px;font-weight:500;color:var(--t1);margin-bottom:4px;}
        .msub{font-size:13px;color:var(--t3);margin-bottom:14px;}
        .pgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px;}
        .pcard{border:1.5px solid var(--border);border-radius:var(--r);padding:10px 12px;cursor:pointer;transition:all .15s;background:var(--surface);}
        .pcard:hover{border-color:var(--blue);background:#f0f6ff;}
        .pcard.sel{border-color:var(--blue);background:#e8f0fe;}
        .pname{font-family:'Google Sans',sans-serif;font-size:13px;font-weight:500;color:var(--t1);display:flex;align-items:center;gap:6px;}
        .pcard.sel .pname{color:var(--blue);}
        .psub{font-size:11px;color:var(--t3);margin-top:2px;}
        .ftag{background:#e6f4ea;color:var(--green);font-size:9px;font-weight:700;padding:1px 5px;border-radius:3px;text-transform:uppercase;letter-spacing:.04em;}
        .amsg{display:none;padding:9px 13px;border-radius:var(--r);font-size:12px;line-height:1.5;margin-bottom:10px;}
        .amsg.err{background:#fce8e6;border:1px solid #f5c6c2;color:#c5221f;}
        .amsg.wrn{background:#fef7e0;border:1px solid #fdd663;color:#7a4a00;}
        .gf{margin-bottom:12px;}
        .gf label{display:block;font-size:11px;font-weight:500;color:var(--t3);margin-bottom:4px;letter-spacing:.03em;}
        .gi,.gta{width:100%;border:1.5px solid var(--border);border-radius:var(--r);padding:10px 14px;font-family:'Roboto',sans-serif;font-size:14px;color:var(--t1);background:var(--surface);outline:none;transition:border-color .15s,box-shadow .15s;}
        .gi:focus,.gta:focus{border-color:var(--blue);box-shadow:0 0 0 2px rgba(26,115,232,.15);}
        .gta{resize:none;height:78px;}
        .khint{font-size:11px;color:var(--t3);margin-top:4px;}
        .khint a,.khint a:visited{color:var(--blue);text-decoration:none;}
        .khint a:hover{text-decoration:underline;}
        .chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
        .chip{background:#f8f9fa;border:1px solid var(--border);border-radius:50px;padding:5px 12px;font-size:12px;cursor:pointer;transition:all .15s;color:var(--t2);}
        .chip:hover{background:#e8f0fe;border-color:var(--blue);color:var(--blue);}
        .mact{display:flex;justify-content:flex-end;gap:8px;margin-top:14px;}
        .btxt{background:none;border:none;color:var(--blue);font-family:'Google Sans',sans-serif;font-size:14px;font-weight:500;padding:10px 16px;border-radius:4px;cursor:pointer;transition:background .15s;}
        .btxt:hover{background:rgba(26,115,232,.08);}
        .bcont{background:var(--blue);color:white;border:none;font-family:'Google Sans',sans-serif;font-size:14px;font-weight:500;padding:10px 22px;border-radius:4px;cursor:pointer;box-shadow:var(--sh1);transition:all .15s;display:flex;align-items:center;gap:6px;}
        .bcont:hover{background:var(--blue-dk);box-shadow:var(--sh2);}
        .bcont:disabled{opacity:.45;cursor:not-allowed;box-shadow:none;}

        /* ‚îÄ‚îÄ WELCOME MODAL ‚îÄ‚îÄ */
        .welcome-icon{font-size:48px;text-align:center;display:block;margin:8px 0 16px;}
        .welcome-steps{display:flex;flex-direction:column;gap:10px;margin:14px 0;}
        .ws{display:flex;align-items:flex-start;gap:12px;background:#f8f9fa;border-radius:var(--r);padding:12px 14px;}
        .ws-num{width:24px;height:24px;border-radius:50%;background:var(--blue);color:white;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;}
        .ws-t{font-family:'Google Sans',sans-serif;font-size:13px;font-weight:500;color:var(--t1);margin-bottom:2px;}
        .ws-d{font-size:12px;color:var(--t3);line-height:1.5;}
        .ws-badge{display:inline-flex;align-items:center;gap:4px;background:#e8f0fe;color:var(--blue);font-size:10px;font-weight:600;padding:2px 8px;border-radius:50px;margin-top:4px;}

        /* ‚îÄ‚îÄ INFO MODAL ‚îÄ‚îÄ */
        .info-sheet{background:var(--surface);border-radius:28px 28px 0 0;width:100%;max-width:680px;max-height:92vh;overflow-y:auto;transform:translateY(30px);transition:transform .3s cubic-bezier(.4,0,.2,1);}
        .mover.open .info-sheet{transform:translateY(0);}
        .info-hero{background:linear-gradient(135deg,var(--blue) 0%,#0d47a1 100%);border-radius:20px 20px 0 0;padding:28px 28px 22px;color:white;}
        .info-hero-title{font-family:'Google Sans',sans-serif;font-size:22px;font-weight:500;margin-bottom:4px;}
        .info-hero-sub{font-size:13px;opacity:.85;}
        .info-body{padding:20px 24px 36px;}
        .info-section{margin-bottom:22px;}
        .info-sec-hd{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
        .info-sec-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
        .info-sec-icon.blue{background:#e8f0fe;color:var(--blue);}
        .info-sec-icon.green{background:#e6f4ea;color:var(--green);}
        .info-sec-icon.yellow{background:#fef7e0;color:#f57f17;}
        .info-sec-icon .material-symbols-outlined{font-size:17px;}
        .info-sec-title{font-family:'Google Sans',sans-serif;font-size:14px;font-weight:500;color:var(--t1);}
        .info-sec-body{font-size:13px;color:var(--t2);line-height:1.7;}
        .info-sec-body p{margin-bottom:8px;}
        .info-step{display:flex;gap:10px;margin-bottom:8px;align-items:flex-start;}
        .info-step-n{background:var(--blue);color:white;width:20px;height:20px;border-radius:50%;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;}
        .info-step-t{font-size:13px;color:var(--t2);line-height:1.6;}
        .info-step-t strong{color:var(--t1);}
        .info-step-t a{color:var(--blue);text-decoration:none;}
        .info-divider{height:1px;background:var(--border);margin:18px 0;}
        .info-security-box{background:#e6f4ea;border:1px solid #ceead6;border-radius:var(--r);padding:14px 16px;display:flex;gap:12px;align-items:flex-start;}
        .info-security-box .material-symbols-outlined{color:var(--green);font-size:20px;flex-shrink:0;margin-top:1px;}
        .info-security-body{font-size:12px;color:#1e4620;line-height:1.6;}
        .provider-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;}
        .prov-card{background:#f8f9fa;border:1px solid var(--border);border-radius:var(--r);padding:10px 12px;}
        .prov-card-name{font-family:'Google Sans',sans-serif;font-size:12px;font-weight:500;color:var(--t1);margin-bottom:2px;}
        .prov-card-detail{font-size:11px;color:var(--t3);}
        .prov-card-detail a{color:var(--blue);text-decoration:none;}
        .free-badge{background:#e6f4ea;color:var(--green);font-size:9px;font-weight:700;padding:1px 5px;border-radius:3px;text-transform:uppercase;letter-spacing:.04em;margin-left:4px;}

        /* ‚îÄ‚îÄ SETTINGS MODAL ‚îÄ‚îÄ */
        .settings-sheet{background:var(--surface);border-radius:28px 28px 0 0;width:100%;max-width:560px;max-height:88vh;overflow-y:auto;transform:translateY(30px);transition:transform .3s cubic-bezier(.4,0,.2,1);}
        .mover.open .settings-sheet{transform:translateY(0);}
        .settings-section{margin-bottom:20px;}
        .settings-label{font-size:11px;font-weight:500;color:var(--t3);letter-spacing:.06em;text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:6px;}
        .settings-label .material-symbols-outlined{font-size:14px;}
        .cid-wrap{position:relative;display:flex;align-items:center;}
        .cid-input{width:100%;border:1.5px solid var(--border);border-radius:var(--r);padding:11px 44px 11px 14px;font-family:'Roboto Mono',monospace;font-size:12px;color:var(--t1);background:var(--surface);outline:none;transition:border-color .15s,box-shadow .15s;}
        .cid-input:focus{border-color:var(--blue);box-shadow:0 0 0 2px rgba(26,115,232,.15);}
        .cid-input.valid{border-color:#ceead6;}
        .cid-input.invalid{border-color:#f5c6c2;}
        .cid-eye{position:absolute;right:12px;background:none;border:none;cursor:pointer;color:var(--t3);display:flex;align-items:center;padding:0;}
        .cid-eye:hover{color:var(--blue);}
        .cid-eye .material-symbols-outlined{font-size:18px;}
        .cid-status{display:flex;align-items:center;gap:6px;font-size:12px;margin-top:6px;min-height:18px;}
        .cid-status.ok{color:var(--green);}
        .cid-status.err{color:var(--red);}
        .cid-status.hint{color:var(--t3);}
        .cid-status .material-symbols-outlined{font-size:14px;}
        .settings-hint-box{background:#f8f9fa;border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;font-size:12px;color:var(--t2);line-height:1.6;margin-top:10px;}
        .settings-hint-box strong{color:var(--t1);}
        .settings-hint-box a{color:var(--blue);text-decoration:none;}
        .settings-hint-box code{background:#e8f0fe;color:var(--blue);padding:1px 5px;border-radius:3px;font-size:11px;}
        .settings-divider{height:1px;background:var(--border);margin:18px 0;}
        .settings-danger-btn{display:flex;align-items:center;gap:8px;background:none;border:1px solid var(--border);color:var(--t3);font-family:'Google Sans',sans-serif;font-size:13px;padding:9px 16px;border-radius:var(--r);cursor:pointer;transition:all .15s;width:100%;}
        .settings-danger-btn:hover{border-color:var(--red);color:var(--red);background:#fce8e6;}
        .settings-danger-btn .material-symbols-outlined{font-size:16px;}

        @media(max-width:768px){
            .main{padding:14px 14px 0;}
            .topbar{padding:0 14px;}
            .appname{display:none;}
            .scard{min-width:80px;padding:10px 12px;}
            .sval{font-size:17px;}
            .provider-grid{grid-template-columns:1fr;}
            .detail-panel{width:100%;top:64px;height:calc(100vh - 64px - 80px);}
            .app-body.panel-open .main{display:none;}
            .dock{bottom:12px;padding:6px 8px;gap:2px;}
            .dock-item{min-width:44px;padding:5px 8px;}
            .dock-ai{padding:7px 12px;font-size:11px;}
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           GOOGLE SIGN-IN SCREEN
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        #signin-screen{
            position:fixed;inset:0;
            background:#f1f3f4;
            z-index:9000;
            display:flex;align-items:center;justify-content:center;
            padding:16px;
        }
        #signin-screen.hidden{display:none;}
        .signin-card{
            background:#fff;
            border:1px solid #dadce0;
            border-radius:8px;
            padding:48px 40px 36px;
            width:100%;max-width:400px;
            text-align:center;
            box-shadow:0 2px 4px rgba(0,0,0,.1),0 4px 16px rgba(0,0,0,.06);
        }
        .signin-logo{width:48px;height:48px;border-radius:12px;background:#1a73e8;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-family:'Google Sans',sans-serif;font-weight:700;font-size:20px;color:white;}
        .signin-title{font-family:'Google Sans',sans-serif;font-size:24px;font-weight:400;color:#202124;margin-bottom:8px;}
        .signin-sub{font-size:14px;color:#5f6368;margin-bottom:32px;line-height:1.5;}
        .signin-google-btn{
            display:flex;align-items:center;justify-content:center;gap:10px;
            width:100%;padding:12px 16px;
            border:1px solid #dadce0;border-radius:4px;
            background:#fff;cursor:pointer;
            font-family:'Roboto',sans-serif;font-size:14px;font-weight:500;color:#3c4043;
            box-shadow:0 1px 2px rgba(60,64,67,.3);
            transition:box-shadow .15s,background .15s;
            margin-bottom:12px;
        }
        .signin-google-btn:hover{background:#f8f9fa;box-shadow:0 1px 4px rgba(60,64,67,.3);}
        .signin-guest-btn{
            background:none;border:none;color:#1a73e8;
            font-family:'Google Sans',sans-serif;font-size:14px;font-weight:500;
            cursor:pointer;padding:8px;border-radius:4px;
            transition:background .15s;
        }
        .signin-guest-btn:hover{background:rgba(26,115,232,.08);}
        .signin-divider{display:flex;align-items:center;gap:12px;margin:16px 0;color:#5f6368;font-size:12px;}
        .signin-divider::before,.signin-divider::after{content:'';flex:1;height:1px;background:#dadce0;}
        .signin-user-row{display:flex;align-items:center;gap:10px;padding:10px 14px;background:#f8f9fa;border-radius:var(--r);margin-bottom:16px;text-align:left;}
        .signin-avatar{width:36px;height:36px;border-radius:50%;background:#1a73e8;color:white;display:flex;align-items:center;justify-content:center;font-family:'Google Sans',sans-serif;font-weight:500;font-size:14px;flex-shrink:0;}
        .signin-avatar img{width:36px;height:36px;border-radius:50%;object-fit:cover;}
        .signin-uname{font-family:'Google Sans',sans-serif;font-size:13px;font-weight:500;color:#202124;}
        .signin-uemail{font-size:11px;color:#5f6368;}
        .signin-error{background:#fce8e6;color:#c5221f;border-radius:4px;padding:10px 14px;font-size:13px;margin-bottom:12px;display:none;text-align:left;}

        /* user avatar in topbar */
        .topbar-avatar{width:32px;height:32px;border-radius:50%;background:#1a73e8;color:white;display:flex;align-items:center;justify-content:center;font-family:'Google Sans',sans-serif;font-weight:500;font-size:13px;cursor:pointer;flex-shrink:0;overflow:hidden;border:2px solid transparent;transition:border-color .15s;}
        .topbar-avatar:hover{border-color:#1a73e8;}
        .topbar-avatar img{width:100%;height:100%;object-fit:cover;}
        .user-menu{position:absolute;top:56px;right:14px;background:#fff;border:1px solid #dadce0;border-radius:8px;box-shadow:0 4px 16px rgba(60,64,67,.2);z-index:1000;min-width:220px;overflow:hidden;display:none;}
        .user-menu.open{display:block;}
        .user-menu-header{padding:16px;border-bottom:1px solid #dadce0;text-align:center;}
        .user-menu-avatar{width:56px;height:56px;border-radius:50%;background:#1a73e8;color:white;display:flex;align-items:center;justify-content:center;font-family:'Google Sans',sans-serif;font-weight:500;font-size:22px;margin:0 auto 8px;overflow:hidden;}
        .user-menu-avatar img{width:100%;height:100%;object-fit:cover;}
        .user-menu-name{font-family:'Google Sans',sans-serif;font-size:14px;font-weight:500;color:#202124;}
        .user-menu-email{font-size:12px;color:#5f6368;margin-top:2px;}
        .user-menu-item{display:flex;align-items:center;gap:10px;padding:10px 16px;font-size:13px;color:#3c4043;cursor:pointer;transition:background .15s;}
        .user-menu-item:hover{background:#f1f3f4;}
        .user-menu-item .material-symbols-outlined{font-size:18px;color:#5f6368;}
        .user-menu-sep{height:1px;background:#dadce0;}

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           API KEY MANAGER (in AI modal)
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .km-toggle{display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:8px 12px;background:#f8f9fa;border:1px solid var(--border);border-radius:var(--r);margin-bottom:10px;user-select:none;}
        .km-toggle-label{font-family:'Google Sans',sans-serif;font-size:13px;font-weight:500;color:var(--t2);display:flex;align-items:center;gap:6px;}
        .km-toggle .material-symbols-outlined{font-size:16px;color:var(--t3);transition:transform .2s;}
        .km-toggle.open .material-symbols-outlined.chevron{transform:rotate(180deg);}
        .km-panel{display:none;border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:12px;}
        .km-panel.open{display:block;}
        .km-list{max-height:280px;overflow-y:auto;}
        .km-row{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);transition:background .15s;}
        .km-row:last-child{border-bottom:none;}
        .km-row:hover{background:#f8f9fa;}
        .km-prov-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
        .km-prov-name{font-family:'Google Sans',sans-serif;font-size:12px;font-weight:500;color:var(--t1);flex:1;}
        .km-key-preview{font-family:'Roboto Mono',monospace;font-size:10px;color:var(--t3);flex:2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .km-actions{display:flex;gap:4px;flex-shrink:0;}
        .km-btn{background:none;border:none;cursor:pointer;color:var(--t3);width:28px;height:28px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
        .km-btn:hover{background:#e8f0fe;color:var(--blue);}
        .km-btn.del:hover{background:#fce8e6;color:var(--red);}
        .km-btn .material-symbols-outlined{font-size:16px;}
        .km-empty{padding:20px;text-align:center;font-size:12px;color:var(--t3);}
        .km-add-row{padding:10px 12px;border-top:1px solid var(--border);background:#f8f9fa;}
        /* Custom provider add form */
        .custom-prov-form{border:1px solid var(--border);border-radius:var(--r);padding:12px;background:#f8f9fa;margin-bottom:12px;display:none;}
        .custom-prov-form.open{display:block;}
        .custom-prov-form .gf{margin-bottom:8px;}
        .custom-prov-form .gf:last-child{margin-bottom:0;}
        .custom-prov-form label{font-size:10px;font-weight:500;color:var(--t3);text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:4px;}
        .custom-prov-form .gi{font-size:13px;padding:8px 10px;}
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     GOOGLE SIGN-IN SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="signin-screen">
  <div class="signin-card">
    <div class="signin-logo">SD</div>
    <div class="signin-title">Sign in to SmartDay</div>
    <div class="signin-sub">Your AI-powered daily planner.<br>Sign in to sync tasks across all your devices.</div>
    <div class="signin-error" id="signin-error"></div>
    <!-- Returning user chip (shown when cookie exists) -->
    <div class="signin-user-row" id="signin-returning-row" style="display:none;">
      <div class="signin-avatar" id="signin-return-avatar">?</div>
      <div>
        <div class="signin-uname" id="signin-return-name">User</div>
        <div class="signin-uemail" id="signin-return-email"></div>
      </div>
    </div>
    <button class="signin-google-btn" onclick="signInWithGoogle()" id="signin-btn">
      <svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
      Continue with Google
    </button>
    <div class="signin-divider">or</div>
    <button class="signin-guest-btn" onclick="continueAsGuest()">Continue without signing in</button>
    <p style="font-size:11px;color:#9aa0a6;margin-top:20px;line-height:1.5;">
      Signing in enables Google Drive sync and saves your API keys securely. Your data stays in your own Google account.
    </p>
  </div>
</div>

<div id="toasts"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL 1 ‚Äî AI PLANNER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="mover" id="aimodal" onclick="closeModal(event)">
  <div class="msheet">
    <div class="mdrag"></div>
    <div class="mbody">
      <div class="mtitle">AI Planner</div>
      <div class="msub">Pick a provider, paste your key, and describe how to update your day.</div>

      <!-- Provider grid ‚Äî built dynamically by JS to include custom providers -->
      <div class="pgrid" id="pgrid"></div>

      <!-- Custom provider add form (collapsible) -->
      <div class="custom-prov-form" id="custom-prov-form">
        <div style="font-family:'Google Sans',sans-serif;font-size:12px;font-weight:500;color:var(--t2);margin-bottom:10px;display:flex;align-items:center;gap:6px;">
          <span class="material-symbols-outlined" style="font-size:15px;">add_circle</span>Add Custom Provider
        </div>
        <div class="gf">
          <label>Provider Name</label>
          <input class="gi" id="cp-name" placeholder="e.g. DeepSeek, Mistral, Anthropic...">
        </div>
        <div class="gf">
          <label>API Endpoint URL</label>
          <input class="gi" id="cp-url" placeholder="https://api.deepseek.com/v1/chat/completions">
        </div>
        <div class="gf">
          <label>Model Name</label>
          <input class="gi" id="cp-model" placeholder="e.g. deepseek-chat">
        </div>
        <div class="gf">
          <label>Key Prefix (optional)</label>
          <input class="gi" id="cp-prefix" placeholder="e.g. sk- (for validation hint)">
        </div>
        <div style="display:flex;gap:8px;margin-top:4px;">
          <button class="btxt" style="padding:6px 12px;font-size:12px;" onclick="cancelCustomProv()">Cancel</button>
          <button class="bcont" style="padding:7px 16px;font-size:12px;" onclick="addCustomProvider()">
            <span class="material-symbols-outlined" style="font-size:13px;">save</span>Save Provider
          </button>
        </div>
      </div>

      <div class="amsg" id="amsg"></div>

      <!-- API Key input -->
      <div class="gf">
        <label id="klbl">API KEY ‚Äî GROQ</label>
        <div style="display:flex;gap:6px;">
          <input type="password" class="gi" id="akey" placeholder="gsk_..." autocomplete="off" style="flex:1;" oninput="onKeyInput()">
          <button class="km-btn" id="akey-eye" onclick="toggleKeyVis()" title="Show/hide key" style="width:38px;height:38px;border:1.5px solid var(--border);border-radius:var(--r);flex-shrink:0;">
            <span class="material-symbols-outlined" id="akey-eye-icon">visibility</span>
          </button>
        </div>
        <div class="khint" id="khint">Free key at <a href="https://console.groq.com/keys" target="_blank">console.groq.com/keys</a> &mdash; no credit card needed.</div>
      </div>

      <!-- Save to Drive row -->
      <div id="key-save-row" style="display:none;margin-bottom:12px;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--t3);">
          <input type="checkbox" id="saveKeyToDrive" checked style="accent-color:var(--blue);width:14px;height:14px;">
          Save this API key to Drive for cross-device access
        </label>
      </div>

      <!-- ‚îÄ‚îÄ API KEY MANAGER (collapsible) ‚îÄ‚îÄ -->
      <div class="km-toggle" id="km-toggle" onclick="toggleKeyManager()">
        <div class="km-toggle-label">
          <span class="material-symbols-outlined" style="font-size:16px;">vpn_key</span>
          Saved API Keys <span id="km-count" style="background:#e8f0fe;color:var(--blue);font-size:10px;padding:1px 6px;border-radius:10px;margin-left:4px;">0</span>
        </div>
        <span class="material-symbols-outlined chevron">expand_more</span>
      </div>
      <div class="km-panel" id="km-panel">
        <div class="km-list" id="km-list"></div>
        <div class="km-add-row" style="display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:11px;color:var(--t3);">Keys sync to Drive automatically</span>
          <button class="btxt" style="font-size:12px;padding:5px 10px;" onclick="showCustomProvForm()">
            <span class="material-symbols-outlined" style="font-size:14px;vertical-align:middle;">add</span> Custom Provider
          </button>
        </div>
      </div>

      <!-- Prompt chips -->
      <div class="chips">
        <div class="chip" onclick="setP('Push everything back 1 hour')">Push back 1hr</div>
        <div class="chip" onclick="setP('Add a 30-minute lunch break')">Add lunch</div>
        <div class="chip" onclick="setP('Optimize for deep work in the morning')">Deep work AM</div>
        <div class="chip" onclick="setP('Add 15-minute buffers between tasks')">Add buffers</div>
        <div class="chip" onclick="setP('Compress schedule to finish by 5pm')">Finish by 5pm</div>
      </div>
      <div class="gf">
        <label>YOUR REQUEST</label>
        <textarea class="gta" id="aprompt" placeholder="e.g. Move everything after 2pm and add a gym session..."></textarea>
      </div>
      <div class="mact">
        <button class="btxt" onclick="closeModal()">Cancel</button>
        <button class="bcont" id="aiBtn" onclick="runAI()">
          <span class="material-symbols-outlined" style="font-size:15px;">auto_awesome</span>
          Generate Plan
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL 2 ‚Äî WELCOME (first-time launch)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="mover" id="welcomemodal">
  <div class="msheet">
    <div class="mdrag"></div>
    <div class="mbody">
      <span class="welcome-icon">üëã</span>
      <div class="mtitle" style="text-align:center;">Welcome to SmartDay!</div>
      <div class="msub" style="text-align:center;">Your personal AI-powered daily planner ‚Äî it lives right in this HTML file.</div>
      <div class="welcome-steps">
        <div class="ws">
          <div class="ws-num">1</div>
          <div>
            <div class="ws-t">Save this file somewhere safe</div>
            <div class="ws-d">This app is a single HTML file. Bookmark it in your browser or move it to a folder you won't lose. On mobile, use <strong>"Add to Home Screen"</strong> for app-like access.</div>
            <span class="ws-badge"><span class="material-symbols-outlined" style="font-size:12px;">bookmark</span> Save / Bookmark this file</span>
          </div>
        </div>
        <div class="ws">
          <div class="ws-num">2</div>
          <div>
            <div class="ws-t">Connect Google Drive for sync</div>
            <div class="ws-d">Tap <strong>Connect Drive</strong> in the top bar. Next time you open the app, it reconnects silently ‚Äî no popup. Your data stays private in your own Drive.</div>
            <span class="ws-badge"><span class="material-symbols-outlined" style="font-size:12px;">cloud_sync</span> Auto-reconnects on return</span>
          </div>
        </div>
        <div class="ws">
          <div class="ws-num">3</div>
          <div>
            <div class="ws-t">Use AI to plan your day</div>
            <div class="ws-d">Tap <strong>AI Planner</strong> in the dock. Get a free key from Groq or Gemini. Once saved to Drive, your key works everywhere automatically.</div>
            <span class="ws-badge"><span class="material-symbols-outlined" style="font-size:12px;">auto_awesome</span> AI-powered scheduling</span>
          </div>
        </div>
        <div class="ws">
          <div class="ws-num">4</div>
          <div>
            <div class="ws-t">Click any task for details</div>
            <div class="ws-d">Click on a task row to open the <strong>Task Details</strong> side panel where you can add notes and descriptions that sync to Drive.</div>
            <span class="ws-badge"><span class="material-symbols-outlined" style="font-size:12px;">side_navigation</span> Slide-in detail panel</span>
          </div>
        </div>
      </div>
      <div class="mact">
        <button class="bcont" onclick="closeWelcome()" style="width:100%;justify-content:center;">
          <span class="material-symbols-outlined" style="font-size:15px;">check_circle</span>
          Got it ‚Äî Let's plan my day!
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL 3 ‚Äî INFO / HELP HUB
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="mover" id="infomodal" onclick="closeInfo(event)">
  <div class="info-sheet">
    <div class="mdrag"></div>
    <div class="info-hero">
      <div class="info-hero-title">üìÖ SmartDay ‚Äî Help &amp; Setup</div>
      <div class="info-hero-sub">Everything you need to know to get the most out of your planner.</div>
    </div>
    <div class="info-body">
      <div class="info-section">
        <div class="info-sec-hd">
          <div class="info-sec-icon blue"><span class="material-symbols-outlined">cloud_sync</span></div>
          <div class="info-sec-title">Setting Up Google Drive Sync</div>
        </div>
        <div class="info-sec-body">
          <div class="info-step"><div class="info-step-n">1</div><div class="info-step-t">Go to <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com</a> and create a project.</div></div>
          <div class="info-step"><div class="info-step-n">2</div><div class="info-step-t">Enable the <strong>Google Drive API</strong> under APIs &amp; Services.</div></div>
          <div class="info-step"><div class="info-step-n">3</div><div class="info-step-t">Create an <strong>OAuth 2.0 Client ID</strong> (Web application).</div></div>
          <div class="info-step"><div class="info-step-n">4</div><div class="info-step-t">Add <code>null</code> (for local files) or your URL to Authorized JavaScript origins.</div></div>
          <div class="info-step"><div class="info-step-n">5</div><div class="info-step-t">Open <strong>‚öôÔ∏è Settings</strong> and paste your Client ID there ‚Äî no code editing needed.</div></div>
          <div class="info-step"><div class="info-step-n">6</div><div class="info-step-t">Click <strong>Connect Drive</strong>. Future visits auto-reconnect silently.</div></div>
        </div>
      </div>
      <div class="info-divider"></div>
      <div class="info-section">
        <div class="info-sec-hd">
          <div class="info-sec-icon yellow"><span class="material-symbols-outlined">vpn_key</span></div>
          <div class="info-sec-title">Getting an AI API Key</div>
        </div>
        <div class="info-sec-body">
          <p>All providers below have free tiers ‚Äî no credit card required:</p>
          <div class="provider-grid">
            <div class="prov-card"><div class="prov-card-name">‚ö° Groq <span class="free-badge">Free</span></div><div class="prov-card-detail"><a href="https://console.groq.com/keys" target="_blank">console.groq.com/keys</a></div></div>
            <div class="prov-card"><div class="prov-card-name">‚≠ê Gemini <span class="free-badge">Free</span></div><div class="prov-card-detail"><a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a></div></div>
            <div class="prov-card"><div class="prov-card-name">üîÑ OpenRouter <span class="free-badge">Free</span></div><div class="prov-card-detail"><a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a></div></div>
            <div class="prov-card"><div class="prov-card-name">ü§ñ OpenAI</div><div class="prov-card-detail"><a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a></div></div>
          </div>
        </div>
      </div>
      <div class="info-divider"></div>
      <div class="info-section">
        <div class="info-sec-hd">
          <div class="info-sec-icon green"><span class="material-symbols-outlined">shield</span></div>
          <div class="info-sec-title">Security &amp; Privacy</div>
        </div>
        <div class="info-security-box">
          <span class="material-symbols-outlined">verified_user</span>
          <div class="info-security-body">
            <strong>Your API key lives only in two places:</strong> browser memory (cleared on tab close) and your own private Drive file (<code>smartday_sync.json</code>). No SmartDay server ever touches it.<br><br>
            <strong>Drive scope:</strong> SmartDay only requests <code>drive.file</code> ‚Äî it can only see files it created.<br><br>
            <strong>Token lifecycle:</strong> The Drive token stays active for the lifetime of your browser tab. It only expires if the Google API returns a 401, at which point you're prompted to reconnect.
          </div>
        </div>
      </div>
      <div class="mact">
        <button class="bcont" onclick="closeInfo()" style="justify-content:center;">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL 4 ‚Äî SETTINGS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="mover" id="settingsmodal" onclick="closeSettings(event)">
  <div class="settings-sheet">
    <div class="mdrag"></div>
    <div class="mbody">
      <div class="mtitle">‚öôÔ∏è Settings</div>
      <div class="msub">Configure your Google Drive connection and app preferences.</div>
      <div class="settings-section">
        <div class="settings-label"><span class="material-symbols-outlined">key</span>Google OAuth Client ID</div>
        <div class="cid-wrap">
          <input class="cid-input" id="cid-input" type="password"
            placeholder="xxxxxxxxxxxx-xxxxxxxx.apps.googleusercontent.com"
            autocomplete="off" oninput="onCidInput()" onpaste="setTimeout(onCidInput,10)">
          <button class="cid-eye" id="cid-eye" onclick="toggleCidVisibility()" title="Show/Hide">
            <span class="material-symbols-outlined" id="cid-eye-icon">visibility</span>
          </button>
        </div>
        <div class="cid-status hint" id="cid-status">
          <span class="material-symbols-outlined">info</span>
          <span id="cid-status-txt">Paste your Client ID above to enable Google Drive sync.</span>
        </div>
        <div class="mact" style="margin-top:10px;">
          <button class="btxt" onclick="clearClientId()">Clear</button>
          <button class="bcont" id="cid-save-btn" onclick="saveClientId()" disabled>
            <span class="material-symbols-outlined" style="font-size:15px;">save</span>Save &amp; Apply
          </button>
        </div>
        <div class="settings-hint-box">
          <strong>How to get your Client ID:</strong><br>
          1. <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com</a> ‚Üí new project<br>
          2. APIs &amp; Services ‚Üí Enable <em>Google Drive API</em><br>
          3. Credentials ‚Üí OAuth 2.0 Client ID ‚Üí Web application<br>
          4. Authorized JS origins: <code>null</code> (local) or your site URL<br>
          5. Paste the ID above and hit <strong>Save &amp; Apply</strong>
        </div>
      </div>
      <div class="settings-divider"></div>
      <div class="settings-section">
        <div class="settings-label"><span class="material-symbols-outlined">restart_alt</span>Reset</div>
        <button class="settings-danger-btn" onclick="resetFirstLaunch()">
          <span class="material-symbols-outlined">replay</span>Show welcome screen again on next open
        </button>
        <button class="settings-danger-btn" style="margin-top:8px;" onclick="clearAllData()">
          <span class="material-symbols-outlined">delete_forever</span>Clear all local data &amp; tasks
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TOP BAR
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="topbar">
  <div class="topbar-l">
    <div class="logo">SD</div>
    <span class="appname">SmartDay</span>
  </div>
  <div class="topbar-r">
    <div class="schip" id="schip">
      <div class="sdot" id="sdot"></div>
      <span id="stxt">Local only</span>
    </div>
    <button class="btn-help" onclick="openInfo()" title="Help &amp; Setup">
      <span class="material-symbols-outlined">help_outline</span>
    </button>
    <button class="btn-help" onclick="openSettings()" title="Settings" id="settingsbtn">
      <span class="material-symbols-outlined">settings</span>
    </button>
    <button class="btn-drive" id="drivebtn" onclick="requestToken()">
      <svg width="16" height="16" viewBox="0 0 87.3 78" xmlns="http://www.w3.org/2000/svg">
        <path d="m6.6 66.85 3.85 6.65c.8 1.4 1.95 2.5 3.3 3.3l13.75-23.8H0c0 1.55.4 3.1 1.2 4.5z" fill="#0066da"/>
        <path d="M43.65 25 29.9 1.2C28.55 2 27.4 3.1 26.6 4.5L1.2 49.15C.4 50.55 0 52.1 0 53.65h27.5z" fill="#00ac47"/>
        <path d="M73.55 76.8c1.35-.8 2.5-1.9 3.3-3.3l1.6-2.75 7.65-13.25c.8-1.4 1.2-2.95 1.2-4.5H59.8l5.65 10.35z" fill="#ea4335"/>
        <path d="M43.65 25 57.4 1.2C56.05.4 54.5 0 52.95 0H34.35c-1.55 0-3.1.45-4.45 1.2z" fill="#00832d"/>
        <path d="M59.8 53.65H27.5L13.75 77.45c1.35.8 2.9 1.2 4.45 1.2h50.9c1.55 0 3.1-.45 4.45-1.2z" fill="#2684fc"/>
        <path d="M73.4 26.45l-12.7-22c-.8-1.4-1.95-2.5-3.3-3.3L43.65 25l16.15 28H87.3c0-1.55-.4-3.1-1.2-4.5z" fill="#ffba00"/>
      </svg>
      Connect Drive
    </button>
    <!-- User avatar (shown after sign-in) -->
    <div class="topbar-avatar" id="topbar-avatar" style="display:none;" onclick="toggleUserMenu()" title="Account">
      <span id="topbar-avatar-initial">?</span>
    </div>
  </div>
</div>

<!-- User account dropdown menu -->
<div class="user-menu" id="user-menu">
  <div class="user-menu-header">
    <div class="user-menu-avatar" id="umenu-avatar"><span id="umenu-initial">?</span></div>
    <div class="user-menu-name" id="umenu-name">User</div>
    <div class="user-menu-email" id="umenu-email"></div>
  </div>
  <div class="user-menu-item" onclick="openSettings();closeUserMenu()">
    <span class="material-symbols-outlined">settings</span>Settings
  </div>
  <div class="user-menu-item" onclick="openModal();closeUserMenu()">
    <span class="material-symbols-outlined">vpn_key</span>Manage API Keys
  </div>
  <div class="user-menu-sep"></div>
  <div class="user-menu-item" onclick="signOut()" style="color:var(--red);">
    <span class="material-symbols-outlined" style="color:var(--red);">logout</span>Sign out
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAIN CONTENT + DETAIL PANEL WRAPPER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="app-body" id="appBody">

  <!-- MAIN PANEL -->
  <div class="main" id="mainPanel">
    <div class="dbanner" id="dbanner">
      <span class="material-symbols-outlined" style="font-size:18px;">cloud_sync</span>
      <span id="dbanner-txt">Connected to Google Drive &mdash; auto-syncs every 3 s after changes</span>
    </div>
    <div class="ph">
      <div>
        <div class="ph-title" id="ptitle">Today's Plan</div>
        <div class="ph-sub" id="pdate"></div>
      </div>
      <div class="pring">
        <svg viewBox="0 0 56 56" width="56" height="56">
          <circle class="pt" cx="28" cy="28" r="22.5"/>
          <circle class="pf" id="parc" cx="28" cy="28" r="22.5"/>
        </svg>
        <div class="plbl" id="plbl">0%</div>
      </div>
    </div>
    <div class="stats">
      <div class="scard">
        <div class="sico b"><span class="material-symbols-outlined">checklist</span></div>
        <div><div class="sval" id="stotal">0</div><div class="slbl">Total</div></div>
      </div>
      <div class="scard">
        <div class="sico g"><span class="material-symbols-outlined">task_alt</span></div>
        <div><div class="sval" id="sdone">0</div><div class="slbl">Done</div></div>
      </div>
      <div class="scard">
        <div class="sico y"><span class="material-symbols-outlined">schedule</span></div>
        <div><div class="sval" id="stime">0h</div><div class="slbl">Scheduled</div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-hd">
        <div class="card-hd-t">Tasks <span style="font-size:11px;color:var(--t3);font-weight:400;margin-left:6px;">‚Äî click a row to add notes</span></div>
        <button class="btn-add" onclick="addRow()">+ Add task</button>
      </div>
      <div class="twrap" id="printarea">
        <table>
          <thead><tr>
            <th style="padding-left:20px;width:30px;">#</th>
            <th style="width:34px;"></th>
            <th style="width:88px;">Time</th>
            <th>Task</th>
            <th style="width:64px;">Mins</th>
            <th style="width:70px;">Priority</th>
            <th style="width:38px;"></th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="empty" class="empty" style="display:none;">
          <span class="material-symbols-outlined">event_note</span>
          <p>No tasks yet.<br>Tap <strong>+ Add task</strong> or use AI to build your plan.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- FEATURE 4 ‚Äî TASK DETAIL PANEL -->
  <div class="detail-panel" id="detailPanel">
    <div class="dp-header">
      <span class="material-symbols-outlined" style="font-size:18px;color:var(--blue);flex-shrink:0;">sticky_note_2</span>
      <div class="dp-title" id="dp-title">Task Details</div>
      <button class="dp-close" onclick="closeDetailPanel()" title="Close panel">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="dp-body">
      <div class="dp-meta" id="dp-meta"></div>
      <div class="dp-field">
        <label>Notes &amp; Description</label>
        <textarea class="dp-textarea" id="dp-desc"
          placeholder="Add context, links, subtasks, or any notes for this task..."
          oninput="onDescInput()"></textarea>
      </div>
      <div class="dp-save-row">
        <button class="dp-save-btn" onclick="saveDesc()" id="dp-save-btn">
          <span class="material-symbols-outlined">save</span>Save Notes
        </button>
      </div>
      <div class="dp-hint">
        <span class="material-symbols-outlined" style="font-size:14px;vertical-align:middle;margin-right:4px;">info</span>
        Notes are saved locally and synced to Google Drive with your tasks.
      </div>
    </div>
  </div>

</div><!-- /app-body -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     FEATURE 3 ‚Äî FLOATING WIN11-STYLE DOCK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="dock" id="dock">
  <button class="dock-item" onclick="addRow()" title="New Task">
    <span class="material-symbols-outlined">add_circle</span>
    <span>New</span>
  </button>
  <button class="dock-item" onclick="openModal()" title="AI Planner" id="dock-ai-btn">
    <span class="material-symbols-outlined">auto_awesome</span>
    <span>AI</span>
  </button>
  <div class="dock-sep"></div>
  <button class="dock-item" onclick="exportPDF()" title="Export PDF">
    <span class="material-symbols-outlined">picture_as_pdf</span>
    <span>PDF</span>
  </button>
  <button class="dock-item" onclick="exportDOCX()" title="Export DOCX">
    <span class="material-symbols-outlined">description</span>
    <span>DOCX</span>
  </button>
  <div class="dock-sep"></div>
  <button class="dock-item" onclick="requestToken()" id="dock-drive-btn" title="Sync Drive">
    <span class="material-symbols-outlined">cloud_sync</span>
    <span>Sync</span>
  </button>
</div>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let GOOGLE_CLIENT_ID = localStorage.getItem('sd_client_id') || 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let tasks = JSON.parse(localStorage.getItem('smartday_v3')||'null') || [
    {id:uid(),text:'Morning Briefing',time:'09:00',duration:30,done:false,priority:'med',description:''},
    {id:uid(),text:'Deep Work Block', time:'10:00',duration:90,done:false,priority:'high',description:''}
];
const CIRC = 2*Math.PI*22.5;
let _storedApiKeys = JSON.parse(localStorage.getItem('sd_api_keys')||'{}');
let activeTaskId = null;

// ‚îÄ‚îÄ AUTH STATE (persisted in localStorage as "cookie" equivalent) ‚îÄ‚îÄ
let _currentUser = JSON.parse(localStorage.getItem('sd_user')||'null');
// { name, email, photoUrl, initial }
let _isGuest = localStorage.getItem('sd_guest') === '1';

// ‚îÄ‚îÄ CUSTOM PROVIDERS (user-defined, persisted) ‚îÄ‚îÄ
let _customProviders = JSON.parse(localStorage.getItem('sd_custom_provs')||'[]');
// [{id, name, url, model, prefix, hint}]

function uid(){return Math.random().toString(36).slice(2,9);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIGN-IN / AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initAuthScreen(){
    // Check if already signed in or guest
    if(_currentUser || _isGuest){
        hideSignInScreen();
        applyUserToUI();
        return;
    }
    // Show returning user info if we have a stored user
    const stored = JSON.parse(localStorage.getItem('sd_user')||'null');
    if(stored){
        document.getElementById('signin-returning-row').style.display='flex';
        const av=document.getElementById('signin-return-avatar');
        av.textContent=stored.initial||stored.name[0].toUpperCase();
        document.getElementById('signin-return-name').textContent=stored.name;
        document.getElementById('signin-return-email').textContent=stored.email||'';
    }
    document.getElementById('signin-screen').classList.remove('hidden');
}

function signInWithGoogle(){
    if(typeof google==='undefined'){
        showSigninError('Google SDK not loaded. Check your internet connection.');
        return;
    }
    if(GOOGLE_CLIENT_ID.startsWith('YOUR_')){
        showSigninError('Google Client ID not configured. Tap "Continue without signing in" to use local mode, or set your Client ID in Settings.');
        return;
    }

    // Use Google Identity Services for sign-in
    // We request openid + email + profile to get user info
    const client = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: 'openid email profile https://www.googleapis.com/auth/drive.file',
        callback: async (resp) => {
            if(resp.error || !resp.access_token){
                showSigninError('Sign-in failed: '+(resp.error||'No token received'));
                return;
            }
            // Fetch user info with token
            try{
                const r = await fetch('https://www.googleapis.com/oauth2/v3/userinfo',
                    {headers:{Authorization:'Bearer '+resp.access_token}});
                const info = await r.json();
                _currentUser = {
                    name: info.name || info.email || 'User',
                    email: info.email || '',
                    photoUrl: info.picture || '',
                    initial: (info.name||info.email||'U')[0].toUpperCase()
                };
                localStorage.setItem('sd_user', JSON.stringify(_currentUser));
                localStorage.removeItem('sd_guest');
                _isGuest = false;

                // Also set the Drive token since we already have it
                token = resp.access_token;
                localStorage.setItem('sd_has_linked_drive','1');

                applyUserToUI();
                hideSignInScreen();
                setSyncUI('ok','Drive connected');
                hideDriveBtn();
                document.getElementById('dbanner').classList.add('show');
                await initDrive();
                toast('Welcome, '+_currentUser.name+'!','ok');
            } catch(e){
                showSigninError('Could not fetch user info: '+e.message);
            }
        }
    });
    document.getElementById('signin-btn').textContent='Signing in...';
    document.getElementById('signin-btn').disabled=true;
    client.requestAccessToken();
}

function continueAsGuest(){
    _isGuest = true;
    localStorage.setItem('sd_guest','1');
    hideSignInScreen();
    applyUserToUI();
    toast('Running in local mode ‚Äî no Drive sync','inf');
}

function hideSignInScreen(){
    document.getElementById('signin-screen').classList.add('hidden');
}

function showSigninError(msg){
    const el=document.getElementById('signin-error');
    el.textContent=msg;el.style.display='block';
    document.getElementById('signin-btn').textContent='Continue with Google';
    document.getElementById('signin-btn').disabled=false;
}

function applyUserToUI(){
    if(_currentUser){
        const av=document.getElementById('topbar-avatar');
        av.style.display='flex';
        const ini=document.getElementById('topbar-avatar-initial');
        if(_currentUser.photoUrl){
            av.innerHTML='<img src="'+_currentUser.photoUrl+'" alt="avatar">';
        } else {
            ini.textContent=_currentUser.initial;
        }
        // User menu
        document.getElementById('umenu-name').textContent=_currentUser.name;
        document.getElementById('umenu-email').textContent=_currentUser.email;
        const uma=document.getElementById('umenu-avatar');
        if(_currentUser.photoUrl){
            uma.innerHTML='<img src="'+_currentUser.photoUrl+'" alt="avatar" style="width:56px;height:56px;border-radius:50%;">';
        } else {
            document.getElementById('umenu-initial').textContent=_currentUser.initial;
        }
        // Hide sign-in button in topbar since user is signed in
        const db=document.getElementById('drivebtn');
        if(db && token) db.style.display='none';
    }
}

function toggleUserMenu(){
    document.getElementById('user-menu').classList.toggle('open');
}
function closeUserMenu(){
    document.getElementById('user-menu').classList.remove('open');
}

function signOut(){
    if(!confirm('Sign out? Your local tasks will remain on this device.'))return;
    _currentUser=null;
    _isGuest=false;
    token=null;
    localStorage.removeItem('sd_user');
    localStorage.removeItem('sd_guest');
    localStorage.removeItem('sd_has_linked_drive');
    localStorage.removeItem('sd_fid');
    closeUserMenu();
    setSyncUI('','Local only');
    showDriveBtn();
    document.getElementById('topbar-avatar').style.display='none';
    document.getElementById('dbanner').classList.remove('show');
    // Show sign-in screen
    localStorage.removeItem('sd_user');
    document.getElementById('signin-screen').classList.remove('hidden');
    document.getElementById('signin-btn').textContent='Continue with Google';
    document.getElementById('signin-btn').disabled=false;
    document.getElementById('signin-error').style.display='none';
    toast('Signed out','inf');
}

// Close user menu on outside click
document.addEventListener('click', e=>{
    const menu=document.getElementById('user-menu');
    const av=document.getElementById('topbar-avatar');
    if(menu&&!menu.contains(e.target)&&!av.contains(e.target)){
        menu.classList.remove('open');
    }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
    const tb=document.getElementById('tbody'),em=document.getElementById('empty');
    tb.innerHTML='';
    const sorted=[...tasks].sort((a,b)=>a.time.localeCompare(b.time));
    const done=tasks.filter(t=>t.done).length;
    const mins=tasks.reduce((s,t)=>s+(parseInt(t.duration)||0),0);
    if(!sorted.length){em.style.display='block';}
    else{
        em.style.display='none';
        sorted.forEach((t,i)=>{
            const tr=document.createElement('tr');
            const isActive = (t.id === activeTaskId);
            tr.className=(t.done?'done':'')+(isActive?' active-row':'');
            tr.dataset.id=t.id;
            const pc={high:'pph',med:'ppm',low:'ppl'};
            const pl={high:'High',med:'Med',low:'Low'};
            // Has description indicator
            const noteIco = t.description ? '<span class="material-symbols-outlined" style="font-size:13px;color:var(--blue);vertical-align:middle;margin-left:4px;" title="Has notes">sticky_note_2</span>' : '';
            tr.innerHTML=
                '<td class="rnum" style="padding-left:20px">'+(i+1)+'</td>'+
                '<td><input type="checkbox" class="gc"'+(t.done?' checked':'')+' onchange="toggle(\''+t.id+'\')" onclick="event.stopPropagation()"></td>'+
                '<td><input type="time" class="tf ftm" value="'+t.time+'" onblur="upd(\''+t.id+'\',\'time\',this.value)" onclick="event.stopPropagation()"></td>'+
                '<td><input type="text" class="tf" value="'+esc(t.text)+'" onblur="upd(\''+t.id+'\',\'text\',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()" onclick="event.stopPropagation()">'+noteIco+'</td>'+
                '<td><input type="number" class="tf fdu" value="'+t.duration+'" min="1" max="480" onblur="upd(\''+t.id+'\',\'duration\',parseInt(this.value)||30)" onclick="event.stopPropagation()"></td>'+
                '<td><span class="pp '+pc[t.priority]+'" onclick="event.stopPropagation();cyPrio(\''+t.id+'\')" title="Click to change">'+pl[t.priority]+'</span></td>'+
                '<td><button class="rdel" onclick="event.stopPropagation();del(\''+t.id+'\')" title="Delete"><span class="material-symbols-outlined">delete</span></button></td>';
            // Row click ‚Üí open detail panel
            tr.addEventListener('click', ()=>openDetailPanel(t.id));
            tb.appendChild(tr);
        });
    }
    const p=tasks.length?Math.round(done/tasks.length*100):0;
    const arc=document.getElementById('parc');
    arc.style.strokeDashoffset=CIRC-(CIRC*p/100);
    arc.style.stroke=p===100?'#1e8e3e':'#1a73e8';
    document.getElementById('plbl').textContent=p+'%';
    document.getElementById('stotal').textContent=tasks.length;
    document.getElementById('sdone').textContent=done;
    const h=mins/60;
    document.getElementById('stime').textContent=h>=1?h.toFixed(1)+'h':mins+'m';
    saveLocal();
    debSync();
}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TASK OPERATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggle(id){const t=tasks.find(t=>t.id===id);if(t){t.done=!t.done;render();}}
function upd(id,k,v){const t=tasks.find(t=>t.id===id);if(t){t[k]=v;render();}}
function del(id){
    if(activeTaskId===id) closeDetailPanel();
    tasks=tasks.filter(t=>t.id!==id);
    render();
    toast('Task removed','inf');
}
function addRow(){
    const newTask={id:uid(),text:'New task',time:'12:00',duration:30,done:false,priority:'med',description:''};
    tasks.push(newTask);
    render();
    setTimeout(()=>{
        const ins=document.querySelectorAll('.tf:not(.ftm):not(.fdu)');
        const l=ins[ins.length-1];
        if(l){l.focus();l.select();}
    },60);
}
function cyPrio(id){const t=tasks.find(t=>t.id===id);if(!t)return;t.priority={high:'med',med:'low',low:'high'}[t.priority]||'med';render();}
function saveLocal(){localStorage.setItem('smartday_v3',JSON.stringify(tasks));}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEATURE 4 ‚Äî TASK DETAIL PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDetailPanel(id){
    const t = tasks.find(t=>t.id===id);
    if(!t) return;

    activeTaskId = id;
    // Update panel content
    document.getElementById('dp-title').textContent = t.text || 'Task Details';
    document.getElementById('dp-desc').value = t.description || '';
    document.getElementById('dp-save-btn').textContent = '';
    document.getElementById('dp-save-btn').innerHTML = '<span class="material-symbols-outlined">save</span>Save Notes';

    // Meta chips
    const pc={high:'pph',med:'ppm',low:'ppl'};
    const pl={high:'High',med:'Med',low:'Low'};
    document.getElementById('dp-meta').innerHTML =
        '<span class="dp-chip"><span class="material-symbols-outlined">schedule</span>'+t.time+'</span>'+
        '<span class="dp-chip"><span class="material-symbols-outlined">timer</span>'+t.duration+'m</span>'+
        '<span class="dp-chip pp '+pc[t.priority]+'" style="border:none;">'+pl[t.priority]+'</span>'+
        (t.done ? '<span class="dp-chip" style="background:#e6f4ea;color:var(--green);border-color:#ceead6;"><span class="material-symbols-outlined">task_alt</span>Done</span>' : '');

    // Open panel & shrink main
    document.getElementById('detailPanel').classList.add('open');
    document.getElementById('appBody').classList.add('panel-open');
    // Re-render to highlight row
    render();
}

function closeDetailPanel(){
    activeTaskId = null;
    document.getElementById('detailPanel').classList.remove('open');
    document.getElementById('appBody').classList.remove('panel-open');
    render(); // clear active row highlight
}

function onDescInput(){
    // Could add auto-save here; for now manual save
}

function saveDesc(){
    if(!activeTaskId) return;
    const t = tasks.find(t=>t.id===activeTaskId);
    if(!t) return;
    t.description = document.getElementById('dp-desc').value;
    // Update panel title if task text changed
    document.getElementById('dp-title').textContent = t.text || 'Task Details';
    render();
    toast('Notes saved ‚úì','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEATURE 1 ‚Äî PERSISTENT TOKEN (No TTL)
// Token lives in memory until the tab is closed or a 401 hits.
// Feature 5 ‚Äî Silent auto-reconnect on page load.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let token=null, fileId=localStorage.getItem('sd_fid')||null;
const FNAME='smartday_sync.json';
const DAPI='https://www.googleapis.com/drive/v3';
const UAPI='https://www.googleapis.com/upload/drive/v3';
let _gisClient = null; // reuse same token client instance

function _buildGisClient(promptMode){
    // promptMode: '' for silent, undefined/omit for normal popup
    return google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope:'https://www.googleapis.com/auth/drive.file',
        prompt: promptMode,
        callback: async r => {
            if(r.error || !r.access_token){
                if(promptMode === ''){
                    // Silent auth failed ‚Äî show button, do nothing else
                    showDriveBtn();
                    console.info('[SmartDay] Silent auth failed:', r.error||'no token');
                } else {
                    toast('Auth error: '+(r.error||'unknown'),'err');
                }
                return;
            }
            token = r.access_token;
            localStorage.setItem('sd_has_linked_drive','1');
            setSyncUI('ok','Drive connected');
            hideDriveBtn();
            document.getElementById('dbanner').classList.add('show');
            // Feature 1: No TTL, no countdown timer ‚Äî token persists until 401
            toast('Connected to Google Drive','ok');
            await initDrive();
        }
    });
}

// Manual connect (shows account picker)
function requestToken(){
    if(typeof google==='undefined'){toast('Google SDK not loaded ‚Äî check internet connection','err');return;}
    if(GOOGLE_CLIENT_ID.startsWith('YOUR_')){
        toast('Client ID not configured ‚Äî tap ‚öôÔ∏è Settings first','err');
        setTimeout(openSettings, 400);
        return;
    }
    _buildGisClient(undefined).requestAccessToken();
}

// Feature 5 ‚Äî Silent auto-reconnect on DOMContentLoaded
function trySilentReconnect(){
    if(typeof google==='undefined'){return;}
    if(GOOGLE_CLIENT_ID.startsWith('YOUR_')){return;}
    const hasLinked = localStorage.getItem('sd_has_linked_drive');
    if(!hasLinked){return;}
    setSyncUI('busy','Reconnecting...');
    _buildGisClient('').requestAccessToken({prompt:''});
}

function showDriveBtn(){
    const db=document.getElementById('drivebtn');
    db.style.display='flex';
    // Keep original Drive SVG
    db.innerHTML=`<svg width="16" height="16" viewBox="0 0 87.3 78" xmlns="http://www.w3.org/2000/svg"><path d="m6.6 66.85 3.85 6.65c.8 1.4 1.95 2.5 3.3 3.3l13.75-23.8H0c0 1.55.4 3.1 1.2 4.5z" fill="#0066da"/><path d="M43.65 25 29.9 1.2C28.55 2 27.4 3.1 26.6 4.5L1.2 49.15C.4 50.55 0 52.1 0 53.65h27.5z" fill="#00ac47"/><path d="M73.55 76.8c1.35-.8 2.5-1.9 3.3-3.3l1.6-2.75 7.65-13.25c.8-1.4 1.2-2.95 1.2-4.5H59.8l5.65 10.35z" fill="#ea4335"/><path d="M43.65 25 57.4 1.2C56.05.4 54.5 0 52.95 0H34.35c-1.55 0-3.1.45-4.45 1.2z" fill="#00832d"/><path d="M59.8 53.65H27.5L13.75 77.45c1.35.8 2.9 1.2 4.45 1.2h50.9c1.55 0 3.1-.45 4.45-1.2z" fill="#2684fc"/><path d="M73.4 26.45l-12.7-22c-.8-1.4-1.95-2.5-3.3-3.3L43.65 25l16.15 28H87.3c0-1.55-.4-3.1-1.2-4.5z" fill="#ffba00"/></svg> Connect Drive`;
    setSyncUI('','Local only');
}
function hideDriveBtn(){
    document.getElementById('drivebtn').style.display='none';
}

// Called when a Drive request returns 401 ‚Äî token silently expired server-side
function handleTokenExpired(){
    token=null;
    showDriveBtn();
    document.getElementById('dbanner').classList.remove('show');
    setSyncUI('','Reconnect Drive');
    toast('Drive session expired ‚Äî tap Reconnect Drive','inf');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRIVE ENGINE
// Payload: { tasks: [...], apiKeys: {...} }
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildPayload(){
    return { tasks, apiKeys: _storedApiKeys, customProviders: _customProviders };
}

async function initDrive(){
    if(!token)return;
    setSyncUI('busy','Checking Drive...');
    try{
        const q=encodeURIComponent("name='"+FNAME+"' and trashed=false");
        const r=await dReq(DAPI+'/files?q='+q+'&fields=files(id,name)','GET');
        const d=await r.json();
        if(d.files&&d.files.length>0){
            fileId=d.files[0].id;
            localStorage.setItem('sd_fid',fileId);
            await loadDrive();
            toast('Synced from Drive','ok');
        } else {
            await createDrive();
            toast('Drive file created','ok');
        }
        setSyncUI('ok','Drive synced');
    }catch(e){
        if(e.message.includes('401')){handleTokenExpired();return;}
        console.error('[Drive init]',e);
        setSyncUI('','Sync error');
        toast('Drive error: '+e.message,'err');
    }
}

async function createDrive(){
    const meta=await(await dReq(DAPI+'/files','POST',{name:FNAME,mimeType:'application/json'})).json();
    fileId=meta.id;
    localStorage.setItem('sd_fid',fileId);
    await uploadDrive();
}

// FEATURE 2 ‚Äî Rock-solid API key persistence
async function loadDrive(){
    if(!token||!fileId)return;
    const r=await dReq(DAPI+'/files/'+fileId+'?alt=media','GET');
    const d=await r.json();

    // Support both old array format and new envelope format
    const rawTasks = Array.isArray(d) ? d : (Array.isArray(d.tasks) ? d.tasks : null);
    const rawKeys  = (!Array.isArray(d) && d.apiKeys && typeof d.apiKeys==='object') ? d.apiKeys : {};
    const rawCustom = (!Array.isArray(d) && Array.isArray(d.customProviders)) ? d.customProviders : [];

    if(rawTasks){
        tasks = rawTasks.map(t=>({
            id:       t.id||uid(),
            text:     t.text||'Untitled',
            time:     /^\d{2}:\d{2}$/.test(t.time)?t.time:'09:00',
            duration: parseInt(t.duration)||30,
            done:     !!t.done,
            priority: ['high','med','low'].includes(t.priority)?t.priority:'med',
            description: t.description||''
        }));
        saveLocal();
        render();
    }

    // Restore API keys
    if(Object.keys(rawKeys).length > 0){
        _storedApiKeys = {...rawKeys, ..._storedApiKeys}; // local keys take priority
        saveApiKeys();
        const savedKey = _storedApiKeys[curProv];
        if(savedKey) document.getElementById('akey').value = savedKey;
        document.getElementById('dbanner-txt').textContent =
            'Drive synced ‚Äî tasks & API keys ready on this device';
        toast('Drive synced ‚Äî API keys loaded ‚úì','ok');
    }

    // Restore custom providers from Drive
    if(rawCustom.length > 0){
        // Merge: avoid duplicates by id
        const existingIds = new Set(_customProviders.map(p=>p.id));
        rawCustom.forEach(p=>{ if(!existingIds.has(p.id)) _customProviders.push(p); });
        localStorage.setItem('sd_custom_provs',JSON.stringify(_customProviders));
    }
}

async function uploadDrive(){
    if(!token||!fileId)return;
    await dReq(UAPI+'/files/'+fileId+'?uploadType=media','PATCH',
        new Blob([JSON.stringify(buildPayload())],{type:'application/json'}),true);
    setSyncUI('ok','Drive synced');
}

// 4 ‚Äî DEBOUNCED SYNC ‚Äî 3 s
let _dt=null;
function debSync(){
    if(!token)return;
    setSyncUI('busy','Saving...');
    clearTimeout(_dt);
    _dt=setTimeout(async()=>{
        try{await uploadDrive();}
        catch(e){
            if(e.message.includes('401')){handleTokenExpired();return;}
            console.error('[sync]',e);setSyncUI('','Sync error');
        }
    },3000);
}

async function dReq(url,method,body,raw){
    if(!token)throw new Error('No token');
    const h={'Authorization':'Bearer '+token};
    if(body&&!raw)h['Content-Type']='application/json';
    const o={method:method||'GET',headers:h};
    if(body)o.body=raw?body:JSON.stringify(body);
    const r=await fetch(url,o);
    // Feature 1 ‚Äî Only expire on actual 401
    if(r.status===401){token=null;throw new Error('401 Unauthorized');}
    if(r.status===429)throw new Error('Rate limit hit');
    return r;
}

function setSyncUI(state,txt){
    const c=document.getElementById('schip'),d=document.getElementById('sdot'),s=document.getElementById('stxt');
    s.textContent=txt; c.className='schip'; d.className='sdot';
    if(state==='ok'){c.classList.add('ok');d.classList.add('live');}
    else if(state==='busy'){c.classList.add('busy');d.classList.add('spin');}
    // Mirror sync state in dock
    const dockSync=document.getElementById('dock-drive-btn');
    if(dockSync){
        dockSync.classList.toggle('active', state==='ok');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI PROVIDERS ‚Äî BUILT-IN + CUSTOM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BUILTIN_PROVS={
    groq:{name:'Groq',emoji:'‚ö°',fmt:'oai',url:'https://api.groq.com/openai/v1/chat/completions',model:'llama-3.3-70b-versatile',
          hint:'Free key at <a href="https://console.groq.com/keys" target="_blank">console.groq.com/keys</a> ‚Äî no credit card.',
          lbl:'API KEY ‚Äî GROQ',ph:'gsk_...',pre:'gsk_',tag:'Free'},
    gemini:{name:'Gemini',emoji:'‚≠ê',fmt:'gem',url:null,model:'gemini-2.0-flash',
            hint:'Free key at <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a> ‚Äî no card.',
            lbl:'API KEY ‚Äî GEMINI',ph:'AIza...',pre:'AIza',tag:'Free'},
    openrouter:{name:'OpenRouter',emoji:'üîÑ',fmt:'oai',url:'https://openrouter.ai/api/v1/chat/completions',model:'meta-llama/llama-3.1-8b-instruct:free',
                hint:'Free key at <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a> ‚Äî no card.',
                lbl:'API KEY ‚Äî OPENROUTER',ph:'sk-or-...',pre:'sk-or-',tag:'Free'},
    openai:{name:'OpenAI',emoji:'ü§ñ',fmt:'oai',url:'https://api.openai.com/v1/chat/completions',model:'gpt-4o-mini',
            hint:'Key at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a> ‚Äî paid.',
            lbl:'API KEY ‚Äî OPENAI',ph:'sk-proj-...',pre:'sk-',tag:null}
};

let curProv='groq';

// Build full provider map (built-in + custom)
function getAllProvs(){
    const all={...BUILTIN_PROVS};
    _customProviders.forEach(cp=>{
        all[cp.id]={
            name:cp.name,emoji:'üîß',fmt:'oai',
            url:cp.url,model:cp.model,
            hint:'Custom provider: '+cp.name,
            lbl:'API KEY ‚Äî '+cp.name.toUpperCase(),
            ph:cp.prefix?(cp.prefix+'...'):'your-api-key',
            pre:cp.prefix||'',
            tag:'Custom',
            isCustom:true
        };
    });
    return all;
}

// ‚îÄ‚îÄ RENDER PROVIDER GRID ‚îÄ‚îÄ
function renderProvGrid(){
    const grid=document.getElementById('pgrid');
    const all=getAllProvs();
    grid.innerHTML='';
    Object.entries(all).forEach(([id,p])=>{
        const div=document.createElement('div');
        div.className='pcard'+(id===curProv?' sel':'');
        div.id='prov-'+id;
        div.onclick=()=>selProv(id);
        div.innerHTML=`<div class="pname">${p.emoji} ${p.name} ${p.tag?'<span class="ftag">'+p.tag+'</span>':''}</div>`+
            `<div class="psub">${p.model}${p.isCustom?` <button class="km-btn del" onclick="event.stopPropagation();removeCustomProv('${id}')" title="Remove" style="display:inline-flex;width:18px;height:18px;vertical-align:middle;margin-left:4px;"><span class="material-symbols-outlined" style="font-size:12px;">close</span></button>`:''}</div>`;
        grid.appendChild(div);
    });
}

function selProv(id){
    curProv=id;
    document.querySelectorAll('.pcard').forEach(c=>c.classList.remove('sel'));
    const el=document.getElementById('prov-'+id);
    if(el)el.classList.add('sel');
    const p=getAllProvs()[id];
    if(!p)return;
    document.getElementById('khint').innerHTML=p.hint;
    document.getElementById('klbl').textContent=p.lbl;
    document.getElementById('akey').placeholder=p.ph;
    document.getElementById('akey').value=_storedApiKeys[id]||'';
    clearMsg();
    if(id==='openai')showMsg('OpenAI may block calls from local files (CORS). Use Groq or OpenRouter ‚Äî both are free.','wrn');
}

// ‚îÄ‚îÄ KEY VISIBILITY TOGGLE ‚îÄ‚îÄ
function toggleKeyVis(){
    const inp=document.getElementById('akey'),icon=document.getElementById('akey-eye-icon');
    inp.type=inp.type==='password'?'text':'password';
    icon.textContent=inp.type==='password'?'visibility':'visibility_off';
}

// ‚îÄ‚îÄ KEY INPUT: auto-detect provider from prefix ‚îÄ‚îÄ
function onKeyInput(){
    const val=document.getElementById('akey').value.trim();
    // Auto-switch provider if prefix matches a different one
    const all=getAllProvs();
    for(const [id,p] of Object.entries(all)){
        if(p.pre && val.startsWith(p.pre) && id!==curProv && val.length>10){
            selProv(id);
            break;
        }
    }
}

// ‚îÄ‚îÄ KEY MANAGER ‚îÄ‚îÄ
function toggleKeyManager(){
    const panel=document.getElementById('km-panel');
    const toggle=document.getElementById('km-toggle');
    const isOpen=panel.classList.toggle('open');
    toggle.classList.toggle('open',isOpen);
    if(isOpen)renderKeyManager();
}

function renderKeyManager(){
    const list=document.getElementById('km-list');
    const all=getAllProvs();
    const keys=Object.keys(_storedApiKeys).filter(k=>_storedApiKeys[k]);
    document.getElementById('km-count').textContent=keys.length;
    if(!keys.length){
        list.innerHTML='<div class="km-empty">No keys saved yet. Paste a key above and run AI ‚Äî it will be saved automatically.</div>';
        return;
    }
    list.innerHTML='';
    keys.forEach(pid=>{
        const p=all[pid]||{name:pid,emoji:'üîë'};
        const k=_storedApiKeys[pid];
        const preview=k.slice(0,6)+'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'+k.slice(-4);
        const row=document.createElement('div');
        row.className='km-row';
        row.innerHTML=
            '<div class="km-prov-icon">'+p.emoji+'</div>'+
            '<div class="km-prov-name">'+p.name+'</div>'+
            '<div class="km-key-preview">'+preview+'</div>'+
            '<div class="km-actions">'+
              '<button class="km-btn" onclick="useKey(\''+pid+'\')" title="Use this key"><span class="material-symbols-outlined">login</span></button>'+
              '<button class="km-btn del" onclick="deleteKey(\''+pid+'\')" title="Delete key"><span class="material-symbols-outlined">delete</span></button>'+
            '</div>';
        list.appendChild(row);
    });
}

function useKey(pid){
    selProv(pid);
    document.getElementById('akey').value=_storedApiKeys[pid]||'';
    toggleKeyManager(); // close panel
    toast('Key loaded for '+((getAllProvs()[pid]||{}).name||pid),'ok');
}

function deleteKey(pid){
    delete _storedApiKeys[pid];
    saveApiKeys();
    renderKeyManager();
    if(curProv===pid) document.getElementById('akey').value='';
    toast('Key removed','inf');
}

function saveApiKeys(){
    localStorage.setItem('sd_api_keys',JSON.stringify(_storedApiKeys));
    // Also sync to Drive payload
    if(token) debSync();
}

// ‚îÄ‚îÄ CUSTOM PROVIDER MANAGEMENT ‚îÄ‚îÄ
function showCustomProvForm(){
    document.getElementById('custom-prov-form').classList.add('open');
    document.getElementById('cp-name').focus();
}
function cancelCustomProv(){
    document.getElementById('custom-prov-form').classList.remove('open');
    ['cp-name','cp-url','cp-model','cp-prefix'].forEach(id=>document.getElementById(id).value='');
}

function addCustomProvider(){
    const name=document.getElementById('cp-name').value.trim();
    const url=document.getElementById('cp-url').value.trim();
    const model=document.getElementById('cp-model').value.trim();
    const prefix=document.getElementById('cp-prefix').value.trim();
    if(!name||!url||!model){toast('Name, URL and Model are required','err');return;}
    const id='custom_'+uid();
    _customProviders.push({id,name,url,model,prefix});
    localStorage.setItem('sd_custom_provs',JSON.stringify(_customProviders));
    cancelCustomProv();
    renderProvGrid();
    selProv(id);
    toast(name+' added as custom provider','ok');
    if(token)debSync();
}

function removeCustomProv(id){
    _customProviders=_customProviders.filter(p=>p.id!==id);
    localStorage.setItem('sd_custom_provs',JSON.stringify(_customProviders));
    if(curProv===id)selProv('groq');
    renderProvGrid();
    toast('Custom provider removed','inf');
}

function openModal(){
    document.getElementById('aimodal').classList.add('open');
    clearMsg();
    document.getElementById('key-save-row').style.display = token ? 'block' : 'none';
    renderProvGrid();
    renderKeyManager();
    const stored=_storedApiKeys[curProv];
    if(stored) document.getElementById('akey').value=stored;
    setTimeout(()=>document.getElementById('aprompt').focus(),300);
}
function closeModal(e){if(!e||e.target===document.getElementById('aimodal'))document.getElementById('aimodal').classList.remove('open');}
function setP(t){document.getElementById('aprompt').value=t;document.getElementById('aprompt').focus();}
function showMsg(m,t){const el=document.getElementById('amsg');el.className='amsg '+(t||'err');el.innerHTML=m;el.style.display='block';}
function clearMsg(){document.getElementById('amsg').style.display='none';}

const PROXY='https://corsproxy.io/?url=';
async function sfetch(url,opts){
    try{return await fetch(url,opts);}
    catch(e){
        if(location.protocol!=='file:'&&location.hostname!=='localhost')throw new Error('Network error: '+e.message);
        return fetch(PROXY+encodeURIComponent(url),opts);
    }
}

function vKey(k,pid){
    const p=getAllProvs()[pid];
    if(!k)return'No API key entered.';
    if(k.includes(' '))return'Key has spaces ‚Äî re-copy carefully.';
    if(p&&p.pre&&!k.startsWith(p.pre))return(p.name||pid)+' keys start with "'+p.pre+'" ‚Äî check provider.';
    if(k.length<20)return'Key looks too short.';
    return null;
}

async function callAI(p,key,sys,usr){
    if(p.fmt==='gem'){
        const url='https://generativelanguage.googleapis.com/v1beta/models/'+p.model+':generateContent?key='+key;
        let r;
        try{r=await sfetch(url,{method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:sys+'\n\n'+usr}]}],generationConfig:{temperature:.3,maxOutputTokens:1500}})});}
        catch(e){throw new Error('Cannot reach Gemini: '+e.message);}
        if(!r.ok){let m='HTTP '+r.status;try{const j=await r.json();m=j.error&&j.error.message||m;}catch(_){}
            if(r.status===401||r.status===403)throw new Error('Key rejected: '+m);
            if(r.status===429)throw new Error('Rate limit ‚Äî wait.');
            throw new Error('Gemini '+r.status+': '+m);}
        const d=await r.json();
        return d.candidates?.[0]?.content?.parts?.[0]?.text||'';
    }
    const h={'Content-Type':'application/json','Authorization':'Bearer '+key};
    if(curProv==='openrouter'){h['HTTP-Referer']='https://smartday.app';h['X-Title']='SmartDay';}
    let r;
    try{r=await sfetch(p.url,{method:'POST',headers:h,body:JSON.stringify({model:p.model,max_tokens:1500,temperature:.3,
        messages:[{role:'system',content:sys},{role:'user',content:usr}]})});}
    catch(e){throw new Error('Cannot reach '+(p.name||'provider')+': '+e.message);}
    if(!r.ok){let m='HTTP '+r.status;try{const j=await r.json();m=j.error?.message||m;}catch(_){}
        if(r.status===401)throw new Error('Invalid key (401).');
        if(r.status===429)throw new Error('Rate limit (429).');
        throw new Error((p.name||'AI')+' '+r.status+': '+m);}
    const d=await r.json();
    return d.choices?.[0]?.message?.content||'';
}

async function runAI(){
    const key=document.getElementById('akey').value.trim();
    const prompt=document.getElementById('aprompt').value.trim();
    const p=getAllProvs()[curProv];
    clearMsg();
    const ke=vKey(key,curProv);
    if(ke){showMsg(ke);return;}
    if(!prompt){showMsg('Describe what you want to change.');return;}

    // Always save key to memory and localStorage
    _storedApiKeys[curProv]=key;
    saveApiKeys();
    // Sync to Drive if connected
    const saveKeyCb=document.getElementById('saveKeyToDrive');
    if(saveKeyCb&&saveKeyCb.checked&&token){
        // debSync will include keys in payload automatically
        debSync();
    }

    const btn=document.getElementById('aiBtn');
    btn.disabled=true;
    btn.innerHTML='<span style="font-size:13px;">‚è≥</span> Processing...';
    setSyncUI('busy',(p.name||'AI')+'...');
    const SYS='You are a productivity planner. Return ONLY a raw JSON array (no markdown, no backticks). Each item: "id"(keep if existing,else short random),"text"(string),"time"(HH:MM 24h),"duration"(int minutes),"done"(bool),"priority"("high"|"med"|"low"),"description"(string,keep existing).';
    const USR='Tasks:\n'+JSON.stringify(tasks)+'\n\nRequest: '+prompt;
    try{
        let raw=await callAI(p,key,SYS,USR);
        raw=raw.trim().replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/```\s*$/,'').trim();
        if(raw.startsWith('{')){const o=JSON.parse(raw);const k=Object.keys(o).find(k=>Array.isArray(o[k]));if(k)raw=JSON.stringify(o[k]);}
        const arr=JSON.parse(raw);
        if(!Array.isArray(arr))throw new Error('Expected JSON array.');
        tasks=arr.map(t=>({
            id:t.id||uid(),text:String(t.text||'Untitled'),
            time:/^\d{2}:\d{2}$/.test(t.time)?t.time:'09:00',
            duration:parseInt(t.duration)||30,done:!!t.done,
            priority:['high','med','low'].includes(t.priority)?t.priority:'med',
            description:t.description||''
        }));
        render(); closeModal(); toast('Plan updated via '+(p.name||'AI'),'ok');
        if(saveKeyCb&&saveKeyCb.checked&&token) toast('API key saved to Drive ‚úì','ok');
    }catch(e){
        console.error('[AI]',e);
        showMsg('<strong>'+(p.name||'AI')+' error:</strong> '+e.message);
        toast((p.name||'AI')+' failed','err');
    }finally{
        btn.disabled=false;
        btn.innerHTML='<span class="material-symbols-outlined" style="font-size:15px;">auto_awesome</span> Generate Plan';
        setSyncUI(token?'ok':'',token?'Drive synced':'Local only');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportPDF(){
    toast('Generating PDF...','inf');
    html2pdf().set({margin:.5,filename:'SmartDay_'+new Date().toISOString().slice(0,10)+'.pdf',
        html2canvas:{scale:2,backgroundColor:'#fff'},jsPDF:{unit:'in',format:'letter',orientation:'portrait'}})
    .from(document.getElementById('printarea')).save();
}
function exportDOCX(){
    const{Document,Packer,Paragraph,TextRun,HeadingLevel}=docx;
    const s=[...tasks].sort((a,b)=>a.time.localeCompare(b.time));
    const doc=new Document({sections:[{children:[
        new Paragraph({text:'SmartDay ‚Äî '+new Date().toDateString(),heading:HeadingLevel.HEADING_1}),
        new Paragraph({text:''}),
        ...s.flatMap(t=>[
            new Paragraph({children:[
                new TextRun({text:t.time+'  ',bold:true}),
                new TextRun({text:t.text+(t.done?' (done)':''),strike:t.done}),
                new TextRun({text:'  ('+t.duration+'m)',color:'888888'})
            ]}),
            ...(t.description?[new Paragraph({children:[new TextRun({text:'  '+t.description,color:'666666',italics:true})]})]:[])
        ])
    ]}]});
    Packer.toBlob(doc).then(b=>{saveAs(b,'SmartDay_'+new Date().toISOString().slice(0,10)+'.docx');toast('DOCX saved','ok');});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg,type){
    const el=document.createElement('div');
    el.className='toast '+(type||'inf');
    el.textContent=msg;
    document.getElementById('toasts').appendChild(el);
    setTimeout(()=>el.remove(),3200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL CONTROLLERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openInfo(){document.getElementById('infomodal').classList.add('open');}
function closeInfo(e){if(!e||e.target===document.getElementById('infomodal'))document.getElementById('infomodal').classList.remove('open');}
function openWelcome(){document.getElementById('welcomemodal').classList.add('open');}
function closeWelcome(){document.getElementById('welcomemodal').classList.remove('open');localStorage.setItem('sd_returning','1');}

function openSettings(){
    document.getElementById('settingsmodal').classList.add('open');
    const inp=document.getElementById('cid-input');
    inp.value=localStorage.getItem('sd_client_id')||'';
    updateCidStatus(inp.value);
}
function closeSettings(e){if(!e||e.target===document.getElementById('settingsmodal'))document.getElementById('settingsmodal').classList.remove('open');}

function toggleCidVisibility(){
    const inp=document.getElementById('cid-input'),icon=document.getElementById('cid-eye-icon');
    inp.type=inp.type==='password'?'text':'password';
    icon.textContent=inp.type==='password'?'visibility':'visibility_off';
}
function onCidInput(){
    const val=document.getElementById('cid-input').value.trim();
    updateCidStatus(val);
    document.getElementById('cid-save-btn').disabled=!isValidCid(val);
}
function isValidCid(v){return v.length>20&&v.includes('.apps.googleusercontent.com')&&!v.startsWith('YOUR_');}
function updateCidStatus(val){
    const el=document.getElementById('cid-status'),txt=document.getElementById('cid-status-txt'),inp=document.getElementById('cid-input');
    inp.classList.remove('valid','invalid');
    if(!val){el.className='cid-status hint';el.querySelector('.material-symbols-outlined').textContent='info';txt.textContent='Paste your Client ID to enable Drive sync.';return;}
    if(isValidCid(val)){el.className='cid-status ok';el.querySelector('.material-symbols-outlined').textContent='check_circle';txt.textContent=localStorage.getItem('sd_client_id')===val?'Client ID active ‚Äî ready.':'Looks valid! Hit Save & Apply.';inp.classList.add('valid');}
    else{el.className='cid-status err';el.querySelector('.material-symbols-outlined').textContent='error';txt.textContent=val.startsWith('YOUR_')?'Still a placeholder ‚Äî paste your real Client ID.':'Should end in .apps.googleusercontent.com';inp.classList.add('invalid');}
}
function saveClientId(){
    const val=document.getElementById('cid-input').value.trim();
    if(!isValidCid(val)){toast('Invalid Client ID','err');return;}
    localStorage.setItem('sd_client_id',val);
    GOOGLE_CLIENT_ID=val;
    updateCidStatus(val);
    document.getElementById('cid-save-btn').disabled=true;
    showDriveBtn();
    toast('Client ID saved ‚Äî tap Connect Drive!','ok');
    updateSettingsBadge();
    setTimeout(()=>document.getElementById('settingsmodal').classList.remove('open'),1200);
}
function clearClientId(){document.getElementById('cid-input').value='';onCidInput();document.getElementById('cid-save-btn').disabled=true;}
function resetFirstLaunch(){localStorage.removeItem('sd_returning');toast('Welcome shows on next open','ok');document.getElementById('settingsmodal').classList.remove('open');}
function clearAllData(){
    if(!confirm('Delete all local tasks and settings?'))return;
    closeDetailPanel();
    localStorage.clear();
    tasks=[];
    render();
    toast('All data cleared','inf');
    document.getElementById('settingsmodal').classList.remove('open');
}
function updateSettingsBadge(){
    const btn=document.getElementById('settingsbtn'),stored=localStorage.getItem('sd_client_id');
    if(!stored||stored.startsWith('YOUR_')){btn.style.borderColor='#f9ab00';btn.style.color='#f57f17';btn.title='Settings ‚Äî Client ID not configured';}
    else{btn.style.borderColor='';btn.style.color='';btn.title='Settings';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIRST-LAUNCH CHECK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkFirstLaunch(){
    if(!localStorage.getItem('sd_returning')) setTimeout(openWelcome, 700);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded',()=>{
    const now=new Date();
    document.getElementById('pdate').textContent=now.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
    document.getElementById('ptitle').textContent=now.toLocaleDateString('en-US',{weekday:'long'})+"'s Plan";

    document.addEventListener('keydown',e=>{
        if(e.key==='Escape'){
            closeModal();
            closeInfo();
            closeSettings();
            closeDetailPanel();
            document.getElementById('welcomemodal').classList.remove('open');
        }
    });

    // Init provider grid on first render
    renderProvGrid();

    render();
    updateSettingsBadge();
    checkFirstLaunch();

    // ‚îÄ‚îÄ AUTH: check sign-in state ‚îÄ‚îÄ
    initAuthScreen();

    // Feature 5 ‚Äî Attempt silent Drive reconnect after GIS SDK loads
    const _silentRetry = setInterval(()=>{
        if(typeof google!=='undefined'&&google.accounts&&google.accounts.oauth2){
            clearInterval(_silentRetry);
            // Only auto-reconnect if user is signed in (not guest)
            if(!_isGuest) trySilentReconnect();
        }
    }, 200);
    setTimeout(()=>clearInterval(_silentRetry), 8000);
});
</script>
</body>
</html>
